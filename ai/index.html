<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Zone ‚Ä¢ AI Chat</title>
<style>
  :root{
    --bg:#0b1020;
    --card:rgba(15,23,48,.68);
    --card2:rgba(16,26,58,.58);
    --stroke:rgba(255,255,255,.10);
    --text:#e8ecff;
    --muted:#a8b0d8;
    --brand:#7c5cff;
    --brand2:#19c37d;
    --danger:#ff4d6d;
    --ring:rgba(124,92,255,.33);
    --shadow: 0 20px 55px rgba(0,0,0,.42);
    --r:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    background:
      radial-gradient(1200px 900px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
      radial-gradient(900px 700px at 90% 20%, rgba(25,195,125,.14), transparent 55%),
      radial-gradient(800px 700px at 50% 110%, rgba(255,77,109,.10), transparent 55%),
      var(--bg);
    color:var(--text);
    overflow-x:hidden;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1200px;margin:0 auto;padding:18px}

  .nav{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 16px;
    border:1px solid var(--stroke);
    background:rgba(15,23,48,.62);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:50;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
  .badge{
    font-size:12px;color:var(--muted);
    border:1px solid rgba(255,255,255,.12);
    padding:4px 10px;border-radius:999px
  }
  .navlinks{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .pill{
    padding:9px 11px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    font-size:13px;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .pill:hover{border-color: rgba(124,92,255,.55); box-shadow: 0 0 0 4px var(--ring); transform: translateY(-1px)}

  .layout{
    margin-top:14px;
    display:grid;
    grid-template-columns: 1fr .42fr;
    gap:14px;
    align-items:stretch;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns:1fr}
  }
  .card{
    border:1px solid var(--stroke);
    background: var(--card);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHeader{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .title{ margin:0; font-size:16px; letter-spacing:.2px; font-weight:1000;}
  .sub{color:var(--muted);font-size:12px;line-height:1.4;margin-top:4px}
  .content{padding:14px}
  .small{font-size:12px;color:var(--muted);line-height:1.45}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .chat{
    display:flex;
    flex-direction:column;
    height: 72vh;
    min-height: 560px;
  }
  @media (max-width: 980px){
    .chat{min-height: 520px;}
  }

  .stream{
    flex:1;
    overflow:auto;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .stream::-webkit-scrollbar{width:10px}
  .stream::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

  .msg{
    display:flex;
    gap:10px;
    align-items:flex-start;
    animation: pop .18s ease;
  }
  @keyframes pop{
    from{opacity:0;transform: translateY(6px)}
    to{opacity:1;transform: translateY(0)}
  }
  .avatar{
    width:36px;height:36px;border-radius:50%;
    object-fit:cover;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    flex:0 0 auto;
  }
  .bubble{
    max-width: 900px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:16px;
    padding:10px 11px;
    line-height:1.5;
    font-size:13px;
    white-space:pre-wrap;
    word-break:break-word;
  }
  .bubble.me{
    background: rgba(124,92,255,.18);
    border-color: rgba(124,92,255,.30);
  }
  .meta{
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
  }

  .composer{
    border-top:1px solid rgba(255,255,255,.08);
    padding:12px 14px;
    display:flex;
    gap:10px;
    align-items:flex-end;
    background: rgba(0,0,0,.06);
  }
  textarea{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.65);
    color:var(--text);
    outline:none;
    resize:none;
    min-height:48px;
    max-height:160px;
  }
  textarea:focus{
    border-color: rgba(124,92,255,.65);
    box-shadow: 0 0 0 5px var(--ring);
  }
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:11px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.75);
    color:var(--text);cursor:pointer;font-weight:1000;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    user-select:none;
  }
  .btn:hover{border-color: rgba(124,92,255,.60); box-shadow:0 0 0 4px var(--ring); transform: translateY(-1px)}
  .btn.green{background: linear-gradient(135deg, rgba(25,195,125,.95), rgba(25,195,125,.40)); border-color: transparent}
  .btn.primary{background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.50)); border-color: transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.3)}

  .chip{
    font-size:11px;color:rgba(232,236,255,.95);
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.10);
    padding:4px 9px;border-radius:999px;
  }
  .chip.good{border-color: rgba(25,195,125,.45); background: rgba(25,195,125,.14);}
  .chip.warn{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.12);}

  .pulseDot{
    width:9px;height:9px;border-radius:50%;
    background:rgba(25,195,125,.95);
    box-shadow: 0 0 0 0 rgba(25,195,125,.45);
    animation: pulse 1.3s infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(25,195,125,.45)}
    70%{box-shadow:0 0 0 12px rgba(25,195,125,0)}
    100%{box-shadow:0 0 0 0 rgba(25,195,125,0)}
  }

  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background: rgba(15,23,48,.88);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:999px;
    box-shadow: var(--shadow);
    color:var(--text);
    display:none; z-index:1000;
  }
</style>
</head>
<body>
<div class="container">

  <div class="nav">
    <div class="brand">ü§ñ Study Zone <span class="badge">AI</span></div>
    <div class="navlinks">
      <a class="pill" href="/home/index.html">Home</a>
      <a class="pill" href="/focus/pomodoro.html">Pomodoro</a>
      <a class="pill" href="/focus/stopwatch.html">Stopwatch</a>
      <a class="pill" href="/planner/index.html">Planner</a>
      <a class="pill" href="/friends/index.html">Friends</a>
      <a class="pill" href="/stats/index.html">Stats</a>
      <a class="pill" href="/community/index.html">Community</a>
      <a class="pill" href="/settings/index.html">Settings</a>
      <a class="pill" href="/ai/index.html">AI Chat</a>
    </div>
  </div>

  <div class="layout">

    <!-- Chat -->
    <div class="card chat">
      <div class="cardHeader">
        <div>
          <h3 class="title">AI Study Chat</h3>
          <div class="sub">Ask doubts, get explanations, plans, quizzes ‚Äî keep it school-friendly.</div>
        </div>
        <div class="row">
          <span class="pulseDot" title="ready"></span>
          <span class="chip good" id="statusChip">Signed in</span>
          <button class="btn" id="clearBtn">Clear</button>
        </div>
      </div>

      <div class="stream" id="stream"></div>

      <div class="composer">
        <textarea id="prompt" placeholder="Ask something‚Ä¶ (Enter = send, Shift+Enter = newline)"></textarea>
        <button class="btn green" id="sendBtn">Send</button>
      </div>
      <div class="content" style="padding-top:10px">
        <div class="small">Tip: Try ‚ÄúExplain like I‚Äôm 11th grade‚Äù, or ‚ÄúGive me 5 practice questions + answers‚Äù.</div>
      </div>
    </div>

    <!-- Side panel -->
    <div class="card">
      <div class="cardHeader">
        <div>
          <h3 class="title">Controls</h3>
          <div class="sub">Make replies more useful.</div>
        </div>
      </div>
      <div class="content">
        <div class="small">Mode</div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" data-mode="tutor">Tutor</button>
          <button class="btn" data-mode="quiz">Quiz</button>
          <button class="btn" data-mode="planner">Planner</button>
        </div>

        <div style="height:12px"></div>

        <div class="small">Grade / Level</div>
        <select id="level" style="width:100%; margin-top:8px; padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(16,26,58,.65); color:var(--text); outline:none;">
          <option value="11">11th</option>
          <option value="10">10th</option>
          <option value="12">12th</option>
          <option value="college">College</option>
        </select>

        <div style="height:12px"></div>

        <div class="small">Keep history</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="saveOnBtn">On</button>
          <button class="btn" id="saveOffBtn">Off</button>
          <span class="chip" id="saveChip">On</span>
        </div>

        <div style="height:12px"></div>

        <div class="small">Quick prompts</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="qpExplain">Explain step-by-step</button>
          <button class="btn" id="qpQuiz">Make a quiz</button>
          <button class="btn" id="qpPlan">Plan my study</button>
        </div>

        <div style="height:12px"></div>

        <div class="small chip warn">Note</div>
        <div class="small" style="margin-top:8px">
          This uses a serverless proxy so your Gemini key stays hidden. If usage gets huge, free tier can hit limits. :contentReference[oaicite:3]{index=3}
        </div>
      </div>
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // ‚úÖ your firebase config (same as your other pages)
  const firebaseConfig = {
    apiKey: "AIzaSyCQZ36IQVFEm-rqyD0WlPO23Sf8Lih5Fo8",
    authDomain: "study-zone-438c4.firebaseapp.com",
    projectId: "study-zone-438c4",
    storageBucket: "study-zone-438c4.firebasestorage.app",
    messagingSenderId: "320895535749",
    appId: "1:320895535749:web:cab35a214ef7c22ae2f7ec"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const stream = document.getElementById("stream");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const toastEl = document.getElementById("toast");
  const statusChip = document.getElementById("statusChip");

  const levelEl = document.getElementById("level");
  const saveChip = document.getElementById("saveChip");
  const saveOnBtn = document.getElementById("saveOnBtn");
  const saveOffBtn = document.getElementById("saveOffBtn");

  let currentUser = null;
  let myProfile = null;
  let mode = "tutor";
  let saveHistory = localStorage.getItem("sz_ai_save") !== "0";

  const HISTORY_KEY = "sz_ai_history_v1";
  let history = [];

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> toastEl.style.display="none", 2400);
  }

  function dice(seed){
    seed = encodeURIComponent(seed || "user");
    return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}`;
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    stream.innerHTML = "";
    for(const m of history){
      const isMe = m.role === "user";
      const av = isMe
        ? (myProfile?.pfp || myProfile?.photoURL || dice(myProfile?.username || myProfile?.displayName || "me"))
        : "https://api.dicebear.com/7.x/bottts/svg?seed=study-zone";
      const name = isMe ? (myProfile?.displayName || "You") : "Study Zone AI";
      const bubbleClass = isMe ? "bubble me" : "bubble";
      const meta = m.meta ? ` ‚Ä¢ ${m.meta}` : "";
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `
        <img class="avatar" src="${av}">
        <div style="min-width:0">
          <div class="small" style="font-weight:900;color:rgba(232,236,255,.92)">${escapeHtml(name)}<span class="meta">${escapeHtml(meta)}</span></div>
          <div class="${bubbleClass}">${escapeHtml(m.text)}</div>
        </div>
      `;
      stream.appendChild(div);
    }
    stream.scrollTop = stream.scrollHeight;
  }

  function loadHistory(){
    if(!saveHistory){ history = []; return; }
    try{
      history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      if(!Array.isArray(history)) history = [];
    }catch{ history = []; }
  }

  function persistHistory(){
    if(!saveHistory) return;
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(-30)));
  }

  function setSaveState(v){
    saveHistory = v;
    localStorage.setItem("sz_ai_save", v ? "1" : "0");
    saveChip.textContent = v ? "On" : "Off";
    if(!v){
      localStorage.removeItem(HISTORY_KEY);
      history = [];
      render();
    }else{
      loadHistory();
      render();
    }
  }

  // Mode buttons
  document.querySelectorAll("[data-mode]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      mode = btn.dataset.mode;
      toast(`Mode: ${mode}`);
    });
  });

  // Quick prompts
  document.getElementById("qpExplain").onclick = ()=> promptEl.value = "Explain this step-by-step like I'm in 11th grade: ";
  document.getElementById("qpQuiz").onclick = ()=> promptEl.value = "Make me a short quiz (5 questions) on: ";
  document.getElementById("qpPlan").onclick = ()=> promptEl.value = "Make me a study plan for today for: ";

  // Save controls
  saveOnBtn.onclick = ()=> setSaveState(true);
  saveOffBtn.onclick = ()=> setSaveState(false);
  saveChip.textContent = saveHistory ? "On" : "Off";

  clearBtn.onclick = ()=>{
    if(confirm("Clear chat?")) {
      history = [];
      localStorage.removeItem(HISTORY_KEY);
      render();
    }
  };

  async function callAI(userText){
    const token = await currentUser.getIdToken(); // client token (we don‚Äôt fully verify server-side in this basic version)
    const payload = {
      mode,
      level: levelEl.value,
      userText,
      // send last 12 messages for context
      history: history.slice(-12).map(m => ({ role: m.role, text: m.text }))
    };

    const res = await fetch("/.netlify/functions/gemini-chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=> ({}));
    if(!res.ok){
      throw new Error(data?.error || `AI error (${res.status})`);
    }
    return data;
  }

  async function send(){
    if(!currentUser){ toast("Login required."); return; }
    const text = promptEl.value.trim();
    if(!text) return;

    promptEl.value = "";
    sendBtn.disabled = true;

    history.push({ role:"user", text });
    render();
    persistHistory();

    // typing bubble
    const typing = { role:"assistant", text:"Typing‚Ä¶" , meta:"" };
    history.push(typing);
    render();

    try{
      const out = await callAI(text);
      typing.text = out.reply || "No reply.";
      typing.meta = out.model || "";
      render();
      persistHistory();
    }catch(e){
      typing.text = "Sorry ‚Äî something failed. Try again in a minute.";
      typing.meta = "error";
      render();
      toast(e.message || "Failed");
    }finally{
      sendBtn.disabled = false;
      promptEl.focus();
    }
  }

  sendBtn.onclick = send;

  promptEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Auth guard + profile
  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      statusChip.textContent = "Not signed in";
      statusChip.className = "chip warn";
      window.location.href = "/index.html";
      return;
    }
    currentUser = user;

    const snap = await getDoc(doc(db, "profiles", user.uid));
    myProfile = snap.exists() ? snap.data() : null;

    statusChip.textContent = "Signed in";
    statusChip.className = "chip good";

    loadHistory();
    if(history.length === 0){
      history = [
        { role:"assistant", text:"Yo üëã Ask me anything study-related. If you want, tell me your subject + what lesson you're on." }
      ];
    }
    render();
  });
</script>
</body>
</html>
