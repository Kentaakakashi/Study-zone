<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Zone ‚Ä¢ Community</title>
<style>
  :root{
    --bg:#0b1020;
    --card:rgba(15,23,48,.68);
    --card2:rgba(16,26,58,.58);
    --stroke:rgba(255,255,255,.10);
    --text:#e8ecff;
    --muted:#a8b0d8;
    --brand:#7c5cff;
    --brand2:#19c37d;
    --danger:#ff4d6d;
    --ring:rgba(124,92,255,.33);
    --shadow: 0 20px 55px rgba(0,0,0,.42);
    --r:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    background:
      radial-gradient(1200px 900px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
      radial-gradient(900px 700px at 90% 20%, rgba(25,195,125,.14), transparent 55%),
      radial-gradient(800px 700px at 50% 110%, rgba(255,77,109,.10), transparent 55%),
      var(--bg);
    color:var(--text);
    overflow-x:hidden;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .nav{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 16px;
    border:1px solid var(--stroke);
    background:rgba(15,23,48,.62);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:50;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
  .badge{
    font-size:12px;color:var(--muted);
    border:1px solid rgba(255,255,255,.12);
    padding:4px 10px;border-radius:999px
  }
  .navlinks{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;align-items:center}
  .pill{
    padding:9px 11px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    font-size:13px;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .pill:hover{border-color: rgba(124,92,255,.55); box-shadow: 0 0 0 4px var(--ring); transform: translateY(-1px)}
  .layout{
    margin-top:14px;
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:14px;
    align-items:stretch;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns:1fr}
  }

  .card{
    border:1px solid var(--stroke);
    background: var(--card);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHeader{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .title{ margin:0; font-size:16px; letter-spacing:.2px; }
  .sub{color:var(--muted);font-size:12px;line-height:1.4;margin-top:4px}
  .content{padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input, textarea, select{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.65);
    color:var(--text);
    outline:none;
  }
  textarea{min-height:90px;resize:vertical}
  input:focus, textarea:focus, select:focus{
    border-color: rgba(124,92,255,.65);
    box-shadow: 0 0 0 5px var(--ring);
  }
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:11px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.75);
    color:var(--text);cursor:pointer;font-weight:900;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    user-select:none;
  }
  .btn:hover{border-color: rgba(124,92,255,.60); box-shadow:0 0 0 4px var(--ring); transform: translateY(-1px)}
  .btn.primary{background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.50)); border-color: transparent}
  .btn.green{background: linear-gradient(135deg, rgba(25,195,125,.95), rgba(25,195,125,.40)); border-color: transparent}
  .btn.danger{background: linear-gradient(135deg, rgba(255,77,109,.95), rgba(255,77,109,.40)); border-color: transparent}
  .btn.ghost{background: transparent}
  .btn.sm{padding:8px 10px;border-radius:12px;font-weight:900;font-size:12px}
  .btn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.3)}
  .small{font-size:12px;color:var(--muted);line-height:1.45}

  .posts{
    display:flex; flex-direction:column; gap:10px;
    max-height: 56vh; overflow:auto; padding-right:4px;
  }
  .posts::-webkit-scrollbar{width:10px}
  .posts::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
  .postItem{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:18px;
    padding:12px;
    cursor:pointer;
    transition: transform .18s ease, border-color .18s ease;
    position:relative;
    overflow:hidden;
  }
  .postItem:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.45)}
  .postItem.active{border-color: rgba(124,92,255,.75); box-shadow: 0 0 0 4px var(--ring)}
  .postTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .postMeta{display:flex;align-items:center;gap:10px;min-width:0}
  .avatar{
    width:38px;height:38px;border-radius:50%;
    object-fit:cover;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
  }
  .names{display:flex;flex-direction:column;gap:1px;min-width:0}
  .displayName{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .username{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .time{font-size:12px;color:var(--muted);white-space:nowrap}
  .postText{
    margin-top:10px;
    font-size:13px;
    line-height:1.45;
    color:rgba(232,236,255,.95);
    display:-webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow:hidden;
  }
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .chip{
    font-size:11px;color:rgba(232,236,255,.95);
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.10);
    padding:4px 9px;border-radius:999px;
  }
  .chip.solved{border-color: rgba(25,195,125,.45); background: rgba(25,195,125,.14);}
  .chip.hot{border-color: rgba(124,92,255,.55); background: rgba(124,92,255,.15);}
  .count{
    position:absolute; top:10px; right:10px;
    font-size:11px; color:rgba(232,236,255,.95);
    background:rgba(124,92,255,.18);
    border:1px solid rgba(124,92,255,.35);
    padding:3px 8px;border-radius:999px;
  }

  .threadWrap{display:flex; flex-direction:column; min-height: 68vh;}
  .threadHeader{
    padding:14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .threadTitle{margin:0;font-size:15px;font-weight:900}
  .threadBody{
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    flex:1;
    overflow:auto;
    max-height: 52vh;
    padding-right:4px;
  }
  .threadBody::-webkit-scrollbar{width:10px}
  .threadBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

  .msg{
    display:flex; gap:10px; align-items:flex-start;
    animation: pop .18s ease;
  }
  @keyframes pop{
    from{opacity:0;transform: translateY(6px)}
    to{opacity:1;transform: translateY(0)}
  }
  .msgMain{flex:1;min-width:0}
  .msgHead{
    display:flex; gap:8px; align-items:baseline; flex-wrap:wrap;
    justify-content:space-between;
  }
  .leftHead{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap;min-width:0}
  .msgName{font-weight:900;font-size:13px}
  .msgUser{font-size:12px;color:var(--muted)}
  .msgTime{font-size:12px;color:var(--muted)}
  .editedTag{font-size:11px;color:rgba(232,236,255,.85);border:1px solid rgba(255,255,255,.12);padding:2px 7px;border-radius:999px;background:rgba(0,0,0,.10)}
  .bubble{
    margin-top:6px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:16px;
    padding:10px 11px;
    line-height:1.45;
    font-size:13px;
    word-wrap:break-word;
    white-space:pre-wrap;
  }
  .bubble.deleted{opacity:.75;font-style:italic}

  .composer{
    border-top:1px solid rgba(255,255,255,.08);
    padding:12px 14px;
    display:flex;gap:10px;align-items:flex-end;
  }
  .composer textarea{min-height:46px;max-height:140px}
  .hintBar{
    padding:10px 14px;
    border-top:1px solid rgba(255,255,255,.08);
    color:var(--muted);
    font-size:12px;
  }

  .reactRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .reactBtn{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.10);
    font-size:12px;
    cursor:pointer;
    transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    user-select:none;
  }
  .reactBtn:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.55); box-shadow:0 0 0 4px var(--ring)}
  .reactBtn.active{border-color: rgba(25,195,125,.65); box-shadow:0 0 0 4px rgba(25,195,125,.15)}
  .reactCount{color:var(--muted);font-weight:900}

  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background: rgba(15,23,48,.88);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:999px;
    box-shadow: var(--shadow);
    color:var(--text);
    display:none; z-index:1000;
  }

  .iconBtn{
    position:relative;
    width:40px;height:40px;border-radius:14px;
    display:inline-flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.55);
    cursor:pointer;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .iconBtn:hover{border-color: rgba(124,92,255,.60); box-shadow:0 0 0 4px var(--ring); transform: translateY(-1px)}
  .dotBadge{
    position:absolute;top:-6px;right:-6px;
    min-width:18px;height:18px;border-radius:999px;
    display:none;align-items:center;justify-content:center;
    background:rgba(255,77,109,.95);
    border:1px solid rgba(255,255,255,.18);
    font-size:11px;font-weight:900;
    padding:0 6px;
  }

  /* Simple modal */
  .modalBack{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center; justify-content:center;
    z-index:2000;
    padding:16px;
  }
  .modal{
    width:min(760px, 100%);
    border:1px solid rgba(255,255,255,.12);
    background: rgba(15,23,48,.92);
    backdrop-filter: blur(12px);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .modalHead{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;justify-content:space-between;align-items:center;gap:10px;
  }
  .modalBody{padding:14px}
  .leaderList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .leaderItem{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:16px;
    padding:10px;
  }
</style>
</head>

<body>
<div class="container">
  <div class="nav">
    <div class="brand">üìö Study Zone <span class="badge">beta</span></div>
    <div class="navlinks">
      <a class="pill" href="/home/index.html">Home</a>
      <a class="pill" href="/focus/pomodoro.html">Pomodoro</a>
      <a class="pill" href="/focus/stopwatch.html">Stopwatch</a>
      <a class="pill" href="/planner/index.html">Planner</a>
      <a class="pill" href="/ai/index.html">AI Chat</a>
      <a class="pill" href="/stats/index.html">Stats</a>
      <a class="pill" href="/community/index.html">Community</a>
      <a class="pill" href="/settings/index.html">Settings</a>

      <button class="iconBtn" id="bellBtn" title="Notifications">
        üîî
        <div class="dotBadge" id="bellBadge">0</div>
      </button>

      <button class="iconBtn" id="leaderBtn" title="Helper leaderboard">üëë</button>
    </div>
  </div>

  <div class="layout">

    <!-- LEFT -->
    <div class="card">
      <div class="cardHeader">
        <div>
          <h3 class="title">Community</h3>
          <div class="sub">Post your questions and get an answer from others.</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="refreshBtn" title="Refresh list">‚Üª</button>
        </div>
      </div>

      <div class="content">
        <!-- Create post -->
        <div class="card" style="background:var(--card2); box-shadow:none; margin-bottom:12px;">
          <div class="content">
            <div class="row" style="justify-content:space-between; align-items:flex-end;">
              <div style="flex:1; min-width:220px;">
                <label class="small">Subject tag</label>
                <select id="tag">
                  <option value="General">General</option>
                  <option value="Maths">Maths</option>
                  <option value="Physics">Physics</option>
                  <option value="Chemistry">Chemistry</option>
                  <option value="Computer Science">Computer Science</option>
                  <option value="Tamil">Tamil</option>
                  <option value="English">English</option>
                </select>
              </div>
              <div style="flex:1; min-width:220px;">
                <label class="small">Title</label>
                <input id="title" placeholder="Short title (e.g., 'Need help with vectors')" maxlength="90">
              </div>
            </div>
            <div style="height:10px"></div>
            <label class="small">Your doubt / question</label>
            <textarea id="body" placeholder="Write your question clearly. Add what you've tried." maxlength="1200"></textarea>
            <div class="row" style="justify-content:space-between; margin-top:10px;">
              <div class="small" id="charCount">0 / 1200</div>
              <button class="btn primary" id="postBtn">Post</button>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card" style="background:rgba(16,26,58,.40); box-shadow:none; margin-bottom:12px;">
          <div class="content">
            <div class="row" style="justify-content:space-between">
              <div class="small" id="listInfo">Loading posts‚Ä¶</div>
              <input id="search" placeholder="Search‚Ä¶" style="width:220px">
            </div>
            <div style="height:10px"></div>
            <div class="row">
              <select id="filterTag" style="max-width:240px">
                <option value="ALL">All tags</option>
                <option value="General">General</option>
                <option value="Maths">Maths</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Tamil">Tamil</option>
                <option value="English">English</option>
              </select>
              <select id="filterStatus" style="max-width:260px">
                <option value="ALL">All</option>
                <option value="UNANSWERED">Unanswered</option>
                <option value="SOLVED">Solved</option>
              </select>
              <select id="sortBy" style="max-width:220px">
                <option value="NEW">Newest</option>
                <option value="ACTIVE">Most active</option>
              </select>
            </div>
            <div class="small" style="margin-top:8px">
              Note: ‚ÄúUnanswered/Active‚Äù uses reply tracking stored on new replies. Old replies may not count until new messages happen.
            </div>
          </div>
        </div>

        <div class="posts" id="posts"></div>

        <div class="small" style="margin-top:10px;">
          Tip: If you haven‚Äôt set a username yet, go to <b>Settings</b>.
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card threadWrap">
      <div class="threadHeader">
        <div>
          <h3 class="threadTitle" id="threadTitle">Select a post</h3>
          <div class="sub" id="threadSub">Open a post from the left to see replies.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn sm green" id="solveBtn" disabled>Mark solved</button>
            <button class="btn sm" id="editPostBtn" disabled>Edit post</button>
            <button class="btn sm danger" id="deletePostBtn" disabled>Delete post</button>
          </div>
        </div>
        <button class="btn" id="copyLinkBtn" disabled>Copy link</button>
      </div>

      <div class="threadBody" id="threadBody">
        <div class="small">No thread selected.</div>
      </div>

      <div class="composer">
        <textarea id="replyText" placeholder="Write a reply‚Ä¶ (Shift+Enter = new line)" disabled></textarea>
        <button class="btn green" id="replyBtn" disabled>Send</button>
      </div>
      <div class="hintBar" id="hintBar">Log in required.</div>
    </div>

  </div>
</div>

<!-- Edit Modal -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <div style="font-weight:900" id="modalTitle">Edit</div>
      <button class="btn sm" id="modalClose">‚úï</button>
    </div>
    <div class="modalBody">
      <label class="small" id="modalLabel">Edit text</label>
      <textarea id="modalText" maxlength="1200"></textarea>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn sm" id="modalCancel">Cancel</button>
        <button class="btn sm primary" id="modalSave">Save</button>
      </div>
      <div class="small" id="modalHint" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- Leaderboard Modal -->
<div class="modalBack" id="leaderBack">
  <div class="modal">
    <div class="modalHead">
      <div style="font-weight:900">üëë Helper Leaderboard (last 7 days)</div>
      <button class="btn sm" id="leaderClose">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small" id="leaderInfo">Loading‚Ä¶</div>
      <div class="leaderList" id="leaderList"></div>
    </div>
  </div>
</div>

<!-- Notifications Modal -->
<div class="modalBack" id="notifBack">
  <div class="modal">
    <div class="modalHead">
      <div style="font-weight:900">üîî Notifications</div>
      <button class="btn sm" id="notifClose">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small">These are new replies on your posts since you last opened notifications.</div>
      <div class="leaderList" id="notifList" style="margin-top:10px"></div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button class="btn sm green" id="notifMarkRead">Mark all read</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, collectionGroup, doc, getDoc, getDocs, addDoc,
    setDoc, updateDoc, deleteDoc, serverTimestamp,
    query, where, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQZ36IQVFEm-rqyD0WlPO23Sf8Lih5Fo8",
    authDomain: "study-zone-438c4.firebaseapp.com",
    projectId: "study-zone-438c4",
    storageBucket: "study-zone-438c4.firebasestorage.app",
    messagingSenderId: "320895535749",
    appId: "1:320895535749:web:cab35a214ef7c22ae2f7ec"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI
  const toastEl = document.getElementById("toast");
  const postsEl = document.getElementById("posts");
  const listInfo = document.getElementById("listInfo");
  const searchEl = document.getElementById("search");
  const titleEl = document.getElementById("title");
  const bodyEl = document.getElementById("body");
  const tagEl = document.getElementById("tag");
  const postBtn = document.getElementById("postBtn");
  const charCount = document.getElementById("charCount");

  const filterTagEl = document.getElementById("filterTag");
  const filterStatusEl = document.getElementById("filterStatus");
  const sortByEl = document.getElementById("sortBy");

  const threadTitleEl = document.getElementById("threadTitle");
  const threadSubEl = document.getElementById("threadSub");
  const threadBodyEl = document.getElementById("threadBody");
  const replyTextEl = document.getElementById("replyText");
  const replyBtn = document.getElementById("replyBtn");
  const hintBar = document.getElementById("hintBar");
  const copyLinkBtn = document.getElementById("copyLinkBtn");
  const refreshBtn = document.getElementById("refreshBtn");

  const solveBtn = document.getElementById("solveBtn");
  const editPostBtn = document.getElementById("editPostBtn");
  const deletePostBtn = document.getElementById("deletePostBtn");

  // Modal edit
  const modalBack = document.getElementById("modalBack");
  const modalTitle = document.getElementById("modalTitle");
  const modalLabel = document.getElementById("modalLabel");
  const modalText = document.getElementById("modalText");
  const modalHint = document.getElementById("modalHint");
  const modalClose = document.getElementById("modalClose");
  const modalCancel = document.getElementById("modalCancel");
  const modalSave = document.getElementById("modalSave");

  // Leaderboard
  const leaderBtn = document.getElementById("leaderBtn");
  const leaderBack = document.getElementById("leaderBack");
  const leaderClose = document.getElementById("leaderClose");
  const leaderInfo = document.getElementById("leaderInfo");
  const leaderList = document.getElementById("leaderList");

  // Notifications
  const bellBtn = document.getElementById("bellBtn");
  const bellBadge = document.getElementById("bellBadge");
  const notifBack = document.getElementById("notifBack");
  const notifClose = document.getElementById("notifClose");
  const notifList = document.getElementById("notifList");
  const notifMarkRead = document.getElementById("notifMarkRead");

  // State
  let currentUser = null;
  let myProfile = null;

  let selectedPostId = null;
  let selectedPostData = null;
  let unsubThread = null;         // listener for replies + accepted answer etc (we rebuild)
  let unsubPostReacts = null;     // listener for post reactions
  let unsubNotif = null;          // notifications listener

  let latestPosts = [];
  const profileCache = new Map();

  // Derived maps
  const replyCountByPost = new Map();    // postId -> count (from recent replies)
  const lastReplyAtByPost = new Map();   // postId -> timestamp millis
  const unreadNotifs = new Map();        // key: replyDocPath -> data

  // Modal state
  let modalMode = null; // "editPost" | "editReply"
  let modalTarget = null;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> toastEl.style.display="none", 2400);
  }

  function dice(seed){
    seed = encodeURIComponent(seed || "user");
    return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}`;
  }

  function tsToDate(ts){
    if(!ts) return null;
    if(typeof ts.toDate === "function") return ts.toDate();
    return null;
  }

  function timeAgo(date){
    if(!date) return "just now";
    const s = Math.max(1, Math.floor((Date.now() - date.getTime())/1000));
    if(s < 60) return `${s}s ago`;
    const m = Math.floor(s/60);
    if(m < 60) return `${m}m ago`;
    const h = Math.floor(m/60);
    if(h < 24) return `${h}h ago`;
    const d = Math.floor(h/24);
    return `${d}d ago`;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function getProfile(uid){
    try{
      if(!uid) return null;
      if(profileCache.has(uid)) return profileCache.get(uid);
      const snap = await getDoc(doc(db,"profiles",uid));
      const p = snap.exists() ? snap.data() : null;
      profileCache.set(uid, p);
      return p;
    }catch{
      profileCache.set(uid, null);
      return null;
    }
  }

  function isMine(uid){
    return !!(currentUser && uid && currentUser.uid === uid);
  }

  function openModal({title, label, text, hint, mode, target}){
    modalTitle.textContent = title;
    modalLabel.textContent = label;
    modalText.value = text || "";
    modalHint.textContent = hint || "";
    modalMode = mode;
    modalTarget = target;
    modalBack.style.display = "flex";
    setTimeout(()=> modalText.focus(), 30);
  }

  function closeModal(){
    modalBack.style.display = "none";
    modalMode = null;
    modalTarget = null;
    modalText.value = "";
  }

  modalClose.onclick = closeModal;
  modalCancel.onclick = closeModal;
  modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

  modalSave.addEventListener("click", async ()=>{
    const newText = modalText.value.trim();
    if(newText.length < 1){ toast("Text can‚Äôt be empty."); return; }
    try{
      modalSave.disabled = true;
      if(modalMode === "editPost"){
        await updateDoc(doc(db,"posts", modalTarget.postId), { body:newText, editedAt:serverTimestamp() });
        toast("Post edited ‚úÖ");
      } else if(modalMode === "editReply"){
        await updateDoc(doc(db,"posts", modalTarget.postId, "replies", modalTarget.replyId), { text:newText, editedAt:serverTimestamp() });
        toast("Reply edited ‚úÖ");
      }
      closeModal();
    }catch(e){
      toast(e.message || "Edit failed.");
    }finally{
      modalSave.disabled = false;
    }
  });

  // ---- Reactions helpers ----
  const REACTS = ["üî•","‚úÖ","üíÄ","‚ù§Ô∏è"];

  function countReacts(docs){
    const c = new Map(REACTS.map(x=>[x,0]));
    let my = null;
    docs.forEach(d=>{
      const data = d.data();
      const em = data.emoji;
      if(c.has(em)) c.set(em, c.get(em)+1);
      if(currentUser && d.id === currentUser.uid) my = em;
    });
    return { counts:c, mine:my };
  }

  function renderReactBar({container, countsMap, mineEmoji, onClick}){
    container.innerHTML = "";
    REACTS.forEach(em=>{
      const cnt = countsMap.get(em) || 0;
      const b = document.createElement("button");
      b.className = `reactBtn ${mineEmoji===em ? "active":""}`;
      b.innerHTML = `<span>${em}</span> <span class="reactCount">${cnt}</span>`;
      b.onclick = ()=> onClick(em, mineEmoji);
      container.appendChild(b);
    });
  }

  async function toggleReaction({type, postId, replyId=null, emoji, currentMine}){
    if(!currentUser){ toast("Login required."); return; }

    // doc id = uid (one reaction per user per message)
    let rRef;
    if(type === "post"){
      rRef = doc(db,"posts",postId,"reactions",currentUser.uid);
    }else{
      rRef = doc(db,"posts",postId,"replies",replyId,"reactions",currentUser.uid);
    }

    try{
      if(currentMine === emoji){
        await deleteDoc(rRef);
      }else{
        await setDoc(rRef, {
          emoji,
          type,
          postId,
          replyId: replyId || null,
          uid: currentUser.uid,
          createdAt: serverTimestamp()
        });
      }
    }catch(e){
      toast(e.message || "Reaction failed.");
    }
  }

  // ---- Posts rendering with filters ----
  function getPostScoreForSort(p){
    const last = lastReplyAtByPost.get(p.id) || (tsToDate(p.createdAt)?.getTime() || 0);
    return last;
  }

  function renderPosts(){
    const textQ = searchEl.value.trim().toLowerCase();
    const tag = filterTagEl.value;
    const status = filterStatusEl.value;
    const sortBy = sortByEl.value;

    let list = latestPosts.slice();

    // filters
    if(tag !== "ALL"){
      list = list.filter(p => (p.tag || "General") === tag);
    }
    if(status === "SOLVED"){
      list = list.filter(p => !!p.solved);
    }
    if(status === "UNANSWERED"){
      list = list.filter(p => (replyCountByPost.get(p.id) || 0) === 0);
    }
    if(textQ){
      list = list.filter(p=>{
        const t = (p.title||"").toLowerCase();
        const b = (p.body||"").toLowerCase();
        const tg = (p.tag||"").toLowerCase();
        return t.includes(textQ) || b.includes(textQ) || tg.includes(textQ);
      });
    }

    // sort
    if(sortBy === "NEW"){
      // newest by createdAt (already from query), but we keep it stable
      // do nothing
    } else {
      // active: last reply time desc
      list.sort((a,b)=> getPostScoreForSort(b) - getPostScoreForSort(a));
    }

    listInfo.textContent = `${list.length} post(s)`;
    postsEl.innerHTML = "";

    list.forEach(p=>{
      const active = p.id === selectedPostId ? "active" : "";
      const el = document.createElement("div");
      el.className = `postItem ${active}`;
      el.dataset.id = p.id;

      const created = tsToDate(p.createdAt);
      const when = timeAgo(created);

      const replies = replyCountByPost.get(p.id) || 0;
      const hot = (sortBy === "ACTIVE" && replies > 0) ? `<span class="chip hot">‚ö° active</span>` : "";

      const chips = [];
      chips.push(`<span class="chip">${escapeHtml(p.tag || "General")}</span>`);
      if(p.solved) chips.push(`<span class="chip solved">‚úÖ Solved</span>`);
      if(p.acceptedReplyId) chips.push(`<span class="chip">üèÜ Answer accepted</span>`);
      if(p.editedAt) chips.push(`<span class="chip">‚úèÔ∏è Edited</span>`);
      if(p.deleted) chips.push(`<span class="chip">üóëÔ∏è Deleted</span>`);
      if(hot) chips.push(hot);

      el.innerHTML = `
        <div class="count">${replies} replies</div>
        <div class="postTop">
          <div class="postMeta">
            <img class="avatar" data-avatar src="${dice(p.authorUid || "user")}">
            <div class="names">
              <div class="displayName" data-dn>Loading‚Ä¶</div>
              <div class="username" data-un>@user</div>
            </div>
          </div>
          <div class="time">${when}</div>
        </div>
        <div class="postText">
          <b>${escapeHtml(p.title || "Untitled")}</b><br>
          ${escapeHtml(p.deleted ? "(This post was deleted.)" : (p.body || ""))}
        </div>
        <div class="chips">${chips.join("")}</div>
      `;

      el.addEventListener("click", ()=> openThread(p.id));
      postsEl.appendChild(el);

      getProfile(p.authorUid).then(profile=>{
        const avEl = el.querySelector("[data-avatar]");
        const dnEl = el.querySelector("[data-dn]");
        const unEl = el.querySelector("[data-un]");
        const disp = profile?.displayName || "User";
        const uname = profile?.username ? `@${profile.username}` : "@no-username";
        const pfp = profile?.pfp || profile?.photoURL || dice(profile?.username || disp);
        avEl.src = pfp; dnEl.textContent = disp; unEl.textContent = uname;
      });
    });

    if(list.length === 0){
      postsEl.innerHTML = `<div class="small">No matching posts. Try changing filters.</div>`;
    }
  }

  // ---- Thread view ----
  async function openThread(postId){
    const p = latestPosts.find(x=>x.id===postId);
    if(!p) return;

    selectedPostId = postId;
    selectedPostData = p;

    renderPosts();

    const created = tsToDate(p.createdAt);
    threadTitleEl.textContent = p.title || "Untitled";
    threadSubEl.textContent = `${p.tag || "General"} ‚Ä¢ ${created ? created.toLocaleString() : "just now"}`;

    copyLinkBtn.disabled = false;

    const minePost = isMine(p.authorUid);
    editPostBtn.disabled = !minePost || !!p.deleted;
    deletePostBtn.disabled = !minePost || !!p.deleted;
    solveBtn.disabled = !minePost || !!p.deleted;
    solveBtn.textContent = p.solved ? "Unmark solved" : "Mark solved";

    replyTextEl.disabled = !!p.deleted;
    replyBtn.disabled = !!p.deleted;

    // clear previous listeners
    if(unsubThread) unsubThread();
    if(unsubPostReacts) unsubPostReacts();

    // Build main post node
    threadBodyEl.innerHTML = "";

    const mainWrap = document.createElement("div");
    mainWrap.className = "msg";
    mainWrap.innerHTML = `
      <img class="avatar" id="mainAvatar" src="${dice(p.authorUid)}">
      <div class="msgMain">
        <div class="msgHead">
          <div class="leftHead">
            <span class="msgName" id="mainName">Loading‚Ä¶</span>
            <span class="msgUser" id="mainUser">@user</span>
            <span class="msgTime">${timeAgo(created)}</span>
            ${p.editedAt ? `<span class="editedTag">edited</span>` : ``}
            ${p.solved ? `<span class="editedTag">‚úÖ solved</span>` : ``}
            ${p.acceptedReplyId ? `<span class="editedTag">üèÜ accepted</span>` : ``}
          </div>
          <div class="row" style="gap:8px"></div>
        </div>
        <div class="bubble ${p.deleted ? "deleted":""}">${escapeHtml(p.deleted ? "(This post was deleted.)" : (p.body || ""))}</div>
        <div class="reactRow" id="postReactRow"></div>
      </div>
    `;
    threadBodyEl.appendChild(mainWrap);

    // fill author
    const authorProfile = await getProfile(p.authorUid);
    document.getElementById("mainName").textContent = authorProfile?.displayName || "User";
    document.getElementById("mainUser").textContent = authorProfile?.username ? `@${authorProfile.username}` : "@no-username";
    document.getElementById("mainAvatar").src = (authorProfile?.pfp || authorProfile?.photoURL || dice(authorProfile?.username || authorProfile?.displayName || "user"));

    // Post reactions live
    const postReactRow = document.getElementById("postReactRow");
    unsubPostReacts = onSnapshot(collection(db,"posts",postId,"reactions"), (snap)=>{
      const {counts, mine} = countReacts(snap.docs);
      renderReactBar({
        container: postReactRow,
        countsMap: counts,
        mineEmoji: mine,
        onClick: (emoji, currentMine)=> toggleReaction({type:"post", postId, emoji, currentMine})
      });
    });

    // Replies live + accepted answer view
    const repliesRef = collection(db, "posts", postId, "replies");
    const q = query(repliesRef, orderBy("createdAt","asc"));

    unsubThread = onSnapshot(q, async (snap) => {
      // rebuild thread, keep mainWrap top
      threadBodyEl.innerHTML = "";
      threadBodyEl.appendChild(mainWrap);

      // accepted answer pinned
      const acceptedId = (selectedPostData && selectedPostData.acceptedReplyId) ? selectedPostData.acceptedReplyId : null;
      let acceptedNode = null;

      if (snap.empty) {
        const empty = document.createElement("div");
        empty.className = "small";
        empty.textContent = "No replies yet. Be the first to reply.";
        empty.dataset.empty = "1";
        threadBodyEl.appendChild(empty);
      } else {
        for (const docSnap of snap.docs) {
          const r = { id: docSnap.id, ...docSnap.data() };
          const rDate = tsToDate(r.createdAt);

          const profile = await getProfile(r.authorUid);
          const disp = profile?.displayName || "User";
          const uname = profile?.username ? `@${profile.username}` : "@no-username";
          const pfp = profile?.pfp || profile?.photoURL || dice(profile?.username || disp);

          const mine = isMine(r.authorUid);
          const edited = !!r.editedAt;
          const deleted = !!r.deleted;
          const isAccepted = acceptedId && r.id === acceptedId;

          const msg = document.createElement("div");
          msg.className = "msg";

          msg.innerHTML = `
            <img class="avatar" src="${pfp}">
            <div class="msgMain">
              <div class="msgHead">
                <div class="leftHead">
                  <span class="msgName">${escapeHtml(disp)}</span>
                  <span class="msgUser">${escapeHtml(uname)}</span>
                  <span class="msgTime">${timeAgo(rDate)}</span>
                  ${edited ? `<span class="editedTag">edited</span>` : ``}
                  ${isAccepted ? `<span class="editedTag">üèÜ accepted answer</span>` : ``}
                </div>
                <div class="row" style="gap:8px">
                  ${minePost && !deleted ? `<button class="btn sm green" data-accept="${r.id}">${isAccepted ? "Unaccept" : "Accept"}</button>` : ``}
                  ${mine && !deleted ? `<button class="btn sm" data-edit-reply="${r.id}">Edit</button>` : ``}
                  ${mine && !deleted ? `<button class="btn sm danger" data-del-reply="${r.id}">Delete</button>` : ``}
                </div>
              </div>
              <div class="bubble ${deleted ? "deleted":""}">${escapeHtml(deleted ? "(This message was deleted.)" : (r.text || ""))}</div>
              <div class="reactRow" data-react-row="${r.id}"></div>
            </div>
          `;

          // wire edit/delete/accept
          if(mine && !deleted){
            const eBtn = msg.querySelector(`[data-edit-reply="${r.id}"]`);
            const dBtn = msg.querySelector(`[data-del-reply="${r.id}"]`);
            if(eBtn){
              eBtn.onclick = () => openModal({
                title: "Edit reply",
                label: "Edit your message",
                text: r.text || "",
                hint: "This will show an ‚Äúedited‚Äù tag.",
                mode: "editReply",
                target: { postId, replyId: r.id }
              });
            }
            if(dBtn){
              dBtn.onclick = async()=>{
                if(!confirm("Delete this reply?")) return;
                try{
                  await updateDoc(doc(db,"posts",postId,"replies",r.id), {
                    deleted:true,
                    text:"(This message was deleted.)",
                    editedAt:serverTimestamp()
                  });
                  toast("Reply deleted ‚úÖ");
                }catch(e){
                  toast(e.message || "Delete failed.");
                }
              };
            }
          }

          if(minePost && !deleted){
            const aBtn = msg.querySelector(`[data-accept="${r.id}"]`);
            if(aBtn){
              aBtn.onclick = async()=>{
                try{
                  await updateDoc(doc(db,"posts",postId), {
                    acceptedReplyId: isAccepted ? null : r.id,
                    editedAt: serverTimestamp()
                  });
                  toast(isAccepted ? "Unaccepted" : "Accepted answer ‚úÖ");
                }catch(e){
                  toast(e.message || "Failed.");
                }
              };
            }
          }

          // reactions on reply (live via per-reply snapshot)
          const reactRow = msg.querySelector(`[data-react-row="${r.id}"]`);
          onSnapshot(collection(db,"posts",postId,"replies",r.id,"reactions"), (rsnap)=>{
            const {counts, mine} = countReacts(rsnap.docs);
            renderReactBar({
              container: reactRow,
              countsMap: counts,
              mineEmoji: mine,
              onClick: (emoji, currentMine)=> toggleReaction({type:"reply", postId, replyId:r.id, emoji, currentMine})
            });
          });

          if(isAccepted){
            acceptedNode = msg;
          } else {
            threadBodyEl.appendChild(msg);
          }
        }
      }

      // Pin accepted at top (below mainWrap)
      if(acceptedNode){
        const pin = document.createElement("div");
        pin.className = "card";
        pin.style.background = "rgba(25,195,125,.10)";
        pin.style.borderColor = "rgba(25,195,125,.35)";
        pin.style.boxShadow = "none";
        pin.style.padding = "10px";
        pin.style.borderRadius = "18px";
        pin.innerHTML = `<div class="small" style="margin-bottom:8px">üèÜ Accepted answer</div>`;
        pin.appendChild(acceptedNode);
        threadBodyEl.insertBefore(pin, threadBodyEl.children[1] || null);
      }

      threadBodyEl.scrollTo({ top: threadBodyEl.scrollHeight, behavior: "smooth" });
    });

    const me = myProfile?.username ? `@${myProfile.username}` : "no username yet";
    hintBar.textContent = `You are replying as ${myProfile?.displayName || "User"} (${me}). Shift+Enter = new line.`;
  }

  // ---- Create post / reply ----
  async function createPost(){
    if(!currentUser) { toast("Login required."); return; }
    if(!myProfile) { toast("Profile loading‚Ä¶"); return; }

    const title = titleEl.value.trim();
    const body = bodyEl.value.trim();
    const tag = tagEl.value;

    if(title.length < 3){ toast("Title is too short."); return; }
    if(body.length < 10){ toast("Write a bit more detail."); return; }

    postBtn.disabled = true;
    try{
      await addDoc(collection(db,"posts"), {
        authorUid: currentUser.uid,
        title,
        body,
        tag,
        createdAt: serverTimestamp(),
        solved: false,
        deleted: false,
        acceptedReplyId: null,
        editedAt: null
      });
      titleEl.value = "";
      bodyEl.value = "";
      charCount.textContent = `0 / 1200`;
      toast("Posted ‚úÖ");
    }catch(e){
      toast(e.message || "Failed to post.");
    }finally{
      postBtn.disabled = false;
    }
  }

  async function sendReply(){
    if(!currentUser) { toast("Login required."); return; }
    if(!selectedPostId || !selectedPostData) { toast("Select a post first."); return; }
    if(selectedPostData.deleted){ toast("This post is deleted."); return; }

    const text = replyTextEl.value.trim();
    if(text.length < 1) return;

    replyBtn.disabled = true;
    try{
      await addDoc(collection(db, "posts", selectedPostId, "replies"), {
        authorUid: currentUser.uid,
        text,
        createdAt: serverTimestamp(),
        editedAt: null,
        deleted: false,

        // üî• added for filters/notifications/leaderboard
        postId: selectedPostId,
        postAuthorUid: selectedPostData.authorUid
      });

      replyTextEl.value = "";
      toast("Sent ‚úÖ");
    }catch(e){
      toast(e.message || "Failed to send.");
    }finally{
      replyBtn.disabled = false;
    }
  }

  // ---- Post tools ----
  editPostBtn.addEventListener("click", ()=>{
    if(!selectedPostId || !selectedPostData) return;
    openModal({
      title: "Edit post",
      label: "Edit your post description",
      text: selectedPostData.body || "",
      hint: "This will show an ‚Äúedited‚Äù tag on the post.",
      mode: "editPost",
      target: { postId: selectedPostId }
    });
  });

  deletePostBtn.addEventListener("click", async ()=>{
    if(!selectedPostId || !selectedPostData) return;
    if(!confirm("Delete this post?")) return;
    try{
      await updateDoc(doc(db,"posts",selectedPostId), {
        deleted:true,
        body:"(This post was deleted.)",
        editedAt:serverTimestamp()
      });
      toast("Post deleted ‚úÖ");
    }catch(e){
      toast(e.message || "Delete failed.");
    }
  });

  solveBtn.addEventListener("click", async ()=>{
    if(!selectedPostId || !selectedPostData) return;
    try{
      await updateDoc(doc(db,"posts",selectedPostId), {
        solved: !selectedPostData.solved,
        editedAt: serverTimestamp()
      });
      toast(selectedPostData.solved ? "Unmarked solved" : "Marked solved ‚úÖ");
    }catch(e){
      toast(e.message || "Failed.");
    }
  });

  // ---- Leaderboard ----
  function openLeader(){
    leaderBack.style.display = "flex";
    buildLeaderboard();
  }
  function closeLeader(){ leaderBack.style.display = "none"; }
  leaderBtn.onclick = openLeader;
  leaderClose.onclick = closeLeader;
  leaderBack.addEventListener("click",(e)=>{ if(e.target===leaderBack) closeLeader(); });

  async function buildLeaderboard(){
    leaderInfo.textContent = "Loading‚Ä¶";
    leaderList.innerHTML = "";

    try{
      const since = new Date(Date.now() - 7*24*60*60*1000);

      // Pull recent replies (limited for cost)
      const q = query(
        collectionGroup(db,"replies"),
        orderBy("createdAt","desc"),
        limit(500)
      );

      const snap = await getDocs(q);

      const counts = new Map(); // uid -> count
      for(const d of snap.docs){
        const r = d.data();
        const dt = tsToDate(r.createdAt);
        if(!dt || dt < since) continue;
        const uid = r.authorUid;
        if(!uid) continue;
        counts.set(uid, (counts.get(uid)||0) + 1);
      }

      const top = [...counts.entries()].sort((a,b)=> b[1]-a[1]).slice(0,10);
      if(top.length === 0){
        leaderInfo.textContent = "No replies in the last 7 days yet.";
        return;
      }
      leaderInfo.textContent = `Top helpers: ${top.length}`;

      for(const [uid, c] of top){
        const prof = await getProfile(uid);
        const disp = prof?.displayName || "User";
        const uname = prof?.username ? `@${prof.username}` : "@no-username";
        const pfp = prof?.pfp || prof?.photoURL || dice(prof?.username || disp);

        const item = document.createElement("div");
        item.className = "leaderItem";
        item.innerHTML = `
          <div class="row" style="gap:10px;flex-wrap:nowrap">
            <img class="avatar" src="${pfp}">
            <div style="min-width:0">
              <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(disp)}</div>
              <div class="small">${escapeHtml(uname)}</div>
            </div>
          </div>
          <div class="chip hot">üí¨ ${c} replies</div>
        `;
        leaderList.appendChild(item);
      }
    }catch(e){
      leaderInfo.textContent = "Failed to load leaderboard.";
    }
  }

  // ---- Notifications ----
  const NOTIF_KEY = "sz_notify_lastSeen";
  function getLastSeenMillis(){
    const v = localStorage.getItem(NOTIF_KEY);
    const n = v ? Number(v) : 0;
    return Number.isFinite(n) ? n : 0;
  }
  function setLastSeenNow(){
    localStorage.setItem(NOTIF_KEY, String(Date.now()));
  }

  function openNotif(){
    notifBack.style.display = "flex";
    renderNotifList();
  }
  function closeNotif(){ notifBack.style.display = "none"; }
  bellBtn.onclick = openNotif;
  notifClose.onclick = closeNotif;
  notifBack.addEventListener("click",(e)=>{ if(e.target===notifBack) closeNotif(); });

  notifMarkRead.onclick = ()=>{
    unreadNotifs.clear();
    setLastSeenNow();
    updateBellBadge();
    renderNotifList();
    toast("Marked read ‚úÖ");
  };

  function updateBellBadge(){
    const n = unreadNotifs.size;
    if(n > 0){
      bellBadge.style.display = "flex";
      bellBadge.textContent = String(n > 99 ? "99+" : n);
    }else{
      bellBadge.style.display = "none";
    }
  }

  async function renderNotifList(){
    notifList.innerHTML = "";
    if(unreadNotifs.size === 0){
      notifList.innerHTML = `<div class="small">No new replies on your posts üéâ</div>`;
      return;
    }

    // show latest 12
    const arr = [...unreadNotifs.values()]
      .sort((a,b)=> (b._ms||0) - (a._ms||0))
      .slice(0,12);

    for(const r of arr){
      const prof = await getProfile(r.authorUid);
      const disp = prof?.displayName || "User";
      const uname = prof?.username ? `@${prof.username}` : "@no-username";
      const pfp = prof?.pfp || prof?.photoURL || dice(prof?.username || disp);

      const item = document.createElement("div");
      item.className = "leaderItem";
      item.innerHTML = `
        <div class="row" style="gap:10px;flex-wrap:nowrap">
          <img class="avatar" src="${pfp}">
          <div style="min-width:0">
            <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(disp)} <span class="small">${escapeHtml(uname)}</span></div>
            <div class="small" style="margin-top:4px">${escapeHtml(r.text || "")}</div>
          </div>
        </div>
        <button class="btn sm" data-open="${r.postId}">Open</button>
      `;
      item.querySelector(`[data-open="${r.postId}"]`).onclick = ()=>{
        closeNotif();
        openThread(r.postId);
      };
      notifList.appendChild(item);
    }
  }

  function startNotifListener(){
    if(unsubNotif) unsubNotif();
    if(!currentUser) return;

    const lastSeen = getLastSeenMillis();

    // Listen to replies that target MY posts (requires reply docs to include postAuthorUid)
    const q = query(
      collectionGroup(db,"replies"),
      where("postAuthorUid","==", currentUser.uid),
      orderBy("createdAt","desc"),
      limit(120)
    );

    unsubNotif = onSnapshot(q, (snap)=>{
      unreadNotifs.clear();

      snap.docs.forEach(d=>{
        const r = d.data();
        const dt = tsToDate(r.createdAt);
        const ms = dt ? dt.getTime() : 0;
        if(ms <= lastSeen) return;
        // don't notify on my own replies
        if(r.authorUid && currentUser && r.authorUid === currentUser.uid) return;

        unreadNotifs.set(d.ref.path, {...r, _ms: ms});
      });

      updateBellBadge();
      if(notifBack.style.display === "flex"){
        renderNotifList();
      }
    });
  }

  // ---- Reply count + active sorting tracker ----
  // We track recent replies across app and map them to postId (works for new replies with postId set).
  function startReplyTracker(){
    const q = query(
      collectionGroup(db,"replies"),
      orderBy("createdAt","desc"),
      limit(600)
    );

    onSnapshot(q, (snap)=>{
      replyCountByPost.clear();
      lastReplyAtByPost.clear();

      snap.docs.forEach(d=>{
        const r = d.data();
        const pid = r.postId;
        if(!pid) return;
        replyCountByPost.set(pid, (replyCountByPost.get(pid)||0) + 1);
        const dt = tsToDate(r.createdAt);
        const ms = dt ? dt.getTime() : 0;
        const prev = lastReplyAtByPost.get(pid) || 0;
        if(ms > prev) lastReplyAtByPost.set(pid, ms);
      });

      renderPosts();
    });
  }

  // ---- Events ----
  bodyEl.addEventListener("input", ()=>{ charCount.textContent = `${bodyEl.value.length} / 1200`; });

  postBtn.addEventListener("click", createPost);
  replyBtn.addEventListener("click", sendReply);
  refreshBtn.addEventListener("click", ()=> renderPosts());

  searchEl.addEventListener("input", renderPosts);
  filterTagEl.addEventListener("change", renderPosts);
  filterStatusEl.addEventListener("change", renderPosts);
  sortByEl.addEventListener("change", renderPosts);

  replyTextEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendReply();
    }
  });

  copyLinkBtn.addEventListener("click", async()=>{
    if(!selectedPostId) return;
    const url = `${window.location.origin}${window.location.pathname}?post=${encodeURIComponent(selectedPostId)}`;
    try{
      await navigator.clipboard.writeText(url);
      toast("Link copied ‚úÖ");
    }catch{
      toast("Copy failed (browser blocked).");
    }
  });

  // ---- Auth + feed ----
  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      window.location.href = "/index.html";
      return;
    }
    currentUser = user;

    const snap = await getDoc(doc(db,"profiles", user.uid));
    myProfile = snap.exists() ? snap.data() : null;

    hintBar.textContent = "Ready ‚úÖ";

    startNotifListener();
    startReplyTracker();
  });

  // Posts feed (real-time)
  const postsQuery = query(collection(db,"posts"), orderBy("createdAt","desc"), limit(120));
  onSnapshot(postsQuery, (snap)=>{
    latestPosts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderPosts();

    // keep selectedPostData fresh
    if(selectedPostId){
      const fresh = latestPosts.find(p=>p.id===selectedPostId);
      if(fresh){
        selectedPostData = fresh;
        const mine = isMine(fresh.authorUid);
        editPostBtn.disabled = !mine || !!fresh.deleted;
        deletePostBtn.disabled = !mine || !!fresh.deleted;
        solveBtn.disabled = !mine || !!fresh.deleted;
        solveBtn.textContent = fresh.solved ? "Unmark solved" : "Mark solved";
        replyTextEl.disabled = !!fresh.deleted;
        replyBtn.disabled = !!fresh.deleted;
      }
    }

    // Auto-open from URL param once
    const url = new URL(window.location.href);
    const postParam = url.searchParams.get("post");
    if(postParam && !selectedPostId){
      const exists = latestPosts.find(x=>x.id===postParam);
      if(exists) openThread(postParam);
    }
  });

  // When opening notifications, mark as read optionally
  bellBtn.addEventListener("dblclick", ()=>{
    setLastSeenNow();
    unreadNotifs.clear();
    updateBellBadge();
    toast("All read ‚úÖ");
  });
</script>
</body>
</html>
