<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Zone ‚Ä¢ Community</title>
<style>
  :root{
    --bg:#0b1020;
    --card:rgba(15,23,48,.68);
    --card2:rgba(16,26,58,.58);
    --stroke:rgba(255,255,255,.10);
    --text:#e8ecff;
    --muted:#a8b0d8;
    --brand:#7c5cff;
    --brand2:#19c37d;
    --danger:#ff4d6d;
    --ring:rgba(124,92,255,.33);
    --shadow: 0 20px 55px rgba(0,0,0,.42);
    --r:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    background:
      radial-gradient(1200px 900px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
      radial-gradient(900px 700px at 90% 20%, rgba(25,195,125,.14), transparent 55%),
      radial-gradient(800px 700px at 50% 110%, rgba(255,77,109,.10), transparent 55%),
      var(--bg);
    color:var(--text);
    overflow-x:hidden;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .nav{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 16px;
    border:1px solid var(--stroke);
    background:rgba(15,23,48,.62);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:50;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
  .badge{
    font-size:12px;color:var(--muted);
    border:1px solid rgba(255,255,255,.12);
    padding:4px 10px;border-radius:999px
  }
  .navlinks{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .pill{
    padding:9px 11px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    font-size:13px;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .pill:hover{border-color: rgba(124,92,255,.55); box-shadow: 0 0 0 4px var(--ring); transform: translateY(-1px)}
  .layout{
    margin-top:14px;
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:14px;
    align-items:stretch;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns:1fr}
  }

  .card{
    border:1px solid var(--stroke);
    background: var(--card);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHeader{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .title{
    margin:0;
    font-size:16px;
    letter-spacing:.2px;
  }
  .sub{color:var(--muted);font-size:12px;line-height:1.4;margin-top:4px}
  .content{padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input, textarea, select{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.65);
    color:var(--text);
    outline:none;
  }
  textarea{min-height:90px;resize:vertical}
  input:focus, textarea:focus, select:focus{
    border-color: rgba(124,92,255,.65);
    box-shadow: 0 0 0 5px var(--ring);
  }
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:11px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.75);
    color:var(--text);cursor:pointer;font-weight:800;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    user-select:none;
  }
  .btn:hover{border-color: rgba(124,92,255,.60); box-shadow:0 0 0 4px var(--ring); transform: translateY(-1px)}
  .btn.primary{background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.50)); border-color: transparent}
  .btn.green{background: linear-gradient(135deg, rgba(25,195,125,.95), rgba(25,195,125,.40)); border-color: transparent}
  .btn.danger{background: linear-gradient(135deg, rgba(255,77,109,.95), rgba(255,77,109,.40)); border-color: transparent}
  .btn.ghost{background: transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.3)}
  .small{font-size:12px;color:var(--muted);line-height:1.45}

  .posts{
    display:flex;
    flex-direction:column;
    gap:10px;
    max-height: 60vh;
    overflow:auto;
    padding-right:4px;
  }
  .posts::-webkit-scrollbar{width:10px}
  .posts::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
  .postItem{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:18px;
    padding:12px;
    cursor:pointer;
    transition: transform .18s ease, border-color .18s ease;
    position:relative;
    overflow:hidden;
  }
  .postItem:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.45)}
  .postItem.active{border-color: rgba(124,92,255,.75); box-shadow: 0 0 0 4px var(--ring)}
  .postTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .postMeta{display:flex;align-items:center;gap:10px;min-width:0}
  .avatar{
    width:38px;height:38px;border-radius:50%;
    object-fit:cover;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
  }
  .names{display:flex;flex-direction:column;gap:1px;min-width:0}
  .displayName{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .username{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .time{font-size:12px;color:var(--muted);white-space:nowrap}
  .postText{
    margin-top:10px;
    font-size:13px;
    line-height:1.45;
    color:rgba(232,236,255,.95);
    display:-webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow:hidden;
  }
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .chip{
    font-size:11px;color:rgba(232,236,255,.95);
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.10);
    padding:4px 9px;border-radius:999px;
  }
  .count{
    position:absolute; top:10px; right:10px;
    font-size:11px; color:rgba(232,236,255,.95);
    background:rgba(124,92,255,.18);
    border:1px solid rgba(124,92,255,.35);
    padding:3px 8px;border-radius:999px;
  }
  .solvedBadge{
    position:absolute; top:10px; left:10px;
    font-size:11px;
    background: rgba(25,195,125,.16);
    border:1px solid rgba(25,195,125,.35);
    padding:3px 8px;border-radius:999px;
  }

  .threadWrap{
    display:flex;
    flex-direction:column;
    min-height: 68vh;
  }
  .threadHeader{
    padding:14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .threadTitle{
    margin:0;
    font-size:15px;
    font-weight:900;
  }
  .threadBody{
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    flex:1;
    overflow:auto;
    max-height: 52vh;
    padding-right:4px;
  }
  .threadBody::-webkit-scrollbar{width:10px}
  .threadBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

  .msg{
    display:flex;
    gap:10px;
    align-items:flex-start;
    animation: pop .18s ease;
  }
  @keyframes pop{
    from{opacity:0;transform: translateY(6px)}
    to{opacity:1;transform: translateY(0)}
  }
  .msgMain{flex:1;min-width:0}
  .msgHead{
    display:flex;gap:8px;align-items:baseline;flex-wrap:wrap;
  }
  .msgName{font-weight:900;font-size:13px}
  .msgUser{font-size:12px;color:var(--muted)}
  .msgTime{font-size:12px;color:var(--muted)}
  .editedTag{
    font-size:11px;
    color:rgba(232,236,255,.9);
    border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.12);
    padding:2px 7px;
    border-radius:999px;
  }
  .bubble{
    margin-top:5px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:16px;
    padding:10px 11px;
    line-height:1.45;
    font-size:13px;
    word-wrap:break-word;
    white-space:pre-wrap;
  }
  .bubble.solved{
    border-color: rgba(25,195,125,.55);
    box-shadow: 0 0 0 4px rgba(25,195,125,.15);
  }

  .msgActions{
    margin-top:8px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .miniBtn{
    padding:7px 9px;
    border-radius:12px;
    font-weight:800;
    font-size:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.55);
    color:var(--text);
    cursor:pointer;
  }
  .miniBtn:hover{border-color: rgba(124,92,255,.60); box-shadow:0 0 0 4px var(--ring)}
  .miniBtn.danger:hover{border-color: rgba(255,77,109,.60); box-shadow:0 0 0 4px rgba(255,77,109,.18)}

  .composer{
    border-top:1px solid rgba(255,255,255,.08);
    padding:12px 14px;
    display:flex;gap:10px;align-items:flex-end;
  }
  .composer textarea{min-height:46px;max-height:140px}
  .hintBar{
    padding:10px 14px;
    border-top:1px solid rgba(255,255,255,.08);
    color:var(--muted);
    font-size:12px;
  }

  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background: rgba(15,23,48,.88);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:999px;
    box-shadow: var(--shadow);
    color:var(--text);
    display:none; z-index:1000;
  }

  /* Modal */
  .modalBackdrop{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    padding:16px;
  }
  .modal{
    width:min(720px, 100%);
    border:1px solid rgba(255,255,255,.12);
    background: rgba(15,23,48,.92);
    backdrop-filter: blur(14px);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .modalHead{
    padding:14px 14px 10px 14px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .modalBody{padding:14px}
  .modalFoot{
    padding:14px;
    border-top:1px solid rgba(255,255,255,.10);
    display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
  }
</style>
</head>

<body>
<div class="container">
  <div class="nav">
    <div class="brand">üìö Study Zone <span class="badge">beta</span></div>
    <div class="navlinks">
      <a class="pill" href="/home/index.html">Home</a>
      <a class="pill" href="/focus/pomodoro.html">Pomodoro</a>
      <a class="pill" href="/focus/stopwatch.html">Stopwatch</a>
      <a class="pill" href="/planner/index.html">Planner</a>
      <a class="pill" href="/stats/index.html">Stats</a>
      <a class="pill" href="/community/index.html">Community</a>
      <a class="pill" href="/settings/index.html">Settings</a>
    </div>
  </div>

  <div class="layout">

    <!-- LEFT: Create + Posts -->
    <div class="card">
      <div class="cardHeader">
        <div>
          <h3 class="title">Community</h3>
          <div class="sub">Real-time threads. Edit/Delete. Mark solutions. Looks like an actual app.</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="refreshBtn" title="Refresh list">‚Üª</button>
        </div>
      </div>

      <div class="content">
        <div class="card" style="background:var(--card2); box-shadow:none; margin-bottom:12px;">
          <div class="content">
            <div class="row" style="justify-content:space-between; align-items:flex-end;">
              <div style="flex:1; min-width:240px;">
                <label class="small">Subject tag</label>
                <select id="subject">
                  <option value="General">General</option>
                  <option value="Maths">Maths</option>
                  <option value="Physics">Physics</option>
                  <option value="Chemistry">Chemistry</option>
                  <option value="Computer Science">Computer Science</option>
                  <option value="Tamil">Tamil</option>
                  <option value="English">English</option>
                </select>
              </div>
              <div style="flex:1; min-width:240px;">
                <label class="small">Title</label>
                <input id="title" placeholder="Short title (e.g., 'Need help with vectors')" maxlength="90">
              </div>
            </div>
            <div style="height:10px"></div>
            <label class="small">Your doubt / question</label>
            <textarea id="body" placeholder="Write your question clearly. Add what you've tried." maxlength="2000"></textarea>
            <div class="row" style="justify-content:space-between; margin-top:10px;">
              <div class="small" id="charCount">0 / 2000</div>
              <button class="btn primary" id="postBtn">Post</button>
            </div>
          </div>
        </div>

        <div class="row" style="justify-content:space-between;">
          <div class="small" id="listInfo">Loading posts‚Ä¶</div>
          <div class="row" style="gap:8px">
            <input id="search" placeholder="Search‚Ä¶" style="width:220px">
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="posts" id="posts"></div>

        <div class="small" style="margin-top:10px;">
          Tip: If your profile looks ‚Äúblank‚Äù, go to <b>Settings</b> and set username + display name.
        </div>
      </div>
    </div>

    <!-- RIGHT: Thread -->
    <div class="card threadWrap">
      <div class="threadHeader">
        <div>
          <h3 class="threadTitle" id="threadTitle">Select a post</h3>
          <div class="sub" id="threadSub">Open a post from the left to see replies.</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="editPostBtn" disabled>Edit post</button>
          <button class="btn danger" id="deletePostBtn" disabled>Delete</button>
        </div>
      </div>

      <div class="threadBody" id="threadBody">
        <div class="small">No thread selected.</div>
      </div>

      <div class="composer">
        <textarea id="replyText" placeholder="Write a reply‚Ä¶ (Shift+Enter = new line)" disabled></textarea>
        <button class="btn green" id="replyBtn" disabled>Send</button>
      </div>
      <div class="hintBar" id="hintBar">Log in required.</div>
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Edit Modal -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Edit</div>
        <div class="small" id="modalSub">Update your text</div>
      </div>
      <button class="btn ghost" id="modalClose">‚úï</button>
    </div>
    <div class="modalBody">
      <label class="small">Text</label>
      <textarea id="modalText" maxlength="2000"></textarea>
      <div class="small" id="modalCount" style="margin-top:8px;">0 / 2000</div>
    </div>
    <div class="modalFoot">
      <button class="btn" id="modalCancel">Cancel</button>
      <button class="btn primary" id="modalSave">Save</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore,
    collection, doc, getDoc, addDoc, updateDoc, deleteDoc,
    serverTimestamp, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // ‚úÖ Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCQZ36IQVFEm-rqyD0WlPO23Sf8Lih5Fo8",
    authDomain: "study-zone-438c4.firebaseapp.com",
    projectId: "study-zone-438c4",
    storageBucket: "study-zone-438c4.firebasestorage.app",
    messagingSenderId: "320895535749",
    appId: "1:320895535749:web:cab35a214ef7c22ae2f7ec"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI refs
  const toastEl = document.getElementById("toast");
  const postsEl = document.getElementById("posts");
  const listInfo = document.getElementById("listInfo");
  const searchEl = document.getElementById("search");

  const titleEl = document.getElementById("title");
  const bodyEl = document.getElementById("body");
  const subjectEl = document.getElementById("subject");
  const postBtn = document.getElementById("postBtn");
  const charCount = document.getElementById("charCount");
  const refreshBtn = document.getElementById("refreshBtn");

  const threadTitleEl = document.getElementById("threadTitle");
  const threadSubEl = document.getElementById("threadSub");
  const threadBodyEl = document.getElementById("threadBody");
  const replyTextEl = document.getElementById("replyText");
  const replyBtn = document.getElementById("replyBtn");
  const hintBar = document.getElementById("hintBar");
  const editPostBtn = document.getElementById("editPostBtn");
  const deletePostBtn = document.getElementById("deletePostBtn");

  // Modal refs
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalClose = document.getElementById("modalClose");
  const modalCancel = document.getElementById("modalCancel");
  const modalSave = document.getElementById("modalSave");
  const modalText = document.getElementById("modalText");
  const modalCount = document.getElementById("modalCount");
  const modalSub = document.getElementById("modalSub");

  // State
  let currentUser = null;
  let myProfile = null;

  let latestPosts = [];
  let selectedPostId = null;
  let selectedPostData = null;
  let unsubReplies = null;

  let modalMode = null; // "post" | "reply"
  let modalTargetId = null; // postId or replyId
  let modalInitial = "";

  const profileCache = new Map(); // uid -> profile

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> toastEl.style.display="none", 2400);
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function dice(seed){
    seed = encodeURIComponent(seed || "user");
    return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}`;
  }

  function tsToDate(ts){
    if(!ts) return null;
    if(typeof ts.toDate === "function") return ts.toDate();
    return null;
  }

  function timeAgo(date){
    if(!date) return "just now";
    const s = Math.max(1, Math.floor((Date.now() - date.getTime())/1000));
    if(s < 60) return `${s}s ago`;
    const m = Math.floor(s/60);
    if(m < 60) return `${m}m ago`;
    const h = Math.floor(m/60);
    if(h < 24) return `${h}h ago`;
    const d = Math.floor(h/24);
    return `${d}d ago`;
  }

  async function getProfile(uid){
    try{
      if(!uid) return null;
      if(profileCache.has(uid)) return profileCache.get(uid);
      const snap = await getDoc(doc(db, "profiles", uid));
      const profile = snap.exists() ? snap.data() : null;
      profileCache.set(uid, profile);
      return profile;
    }catch{
      profileCache.set(uid, null);
      return null;
    }
  }

  function getDisplayFrom(profile, fallbackAuthor, uid){
    const disp = profile?.displayName || fallbackAuthor || "User";
    const uname = profile?.username ? `@${profile.username}` : "@no-username";
    const pfp = profile?.pfp || profile?.photoURL || dice(profile?.username || disp || uid || "user");
    return { disp, uname, pfp };
  }

  // ---------- Modal ----------
  function openModal({mode, targetId, initialText, subText}){
    modalMode = mode;
    modalTargetId = targetId;
    modalInitial = initialText || "";
    modalSub.textContent = subText || "Update your text";
    modalText.value = modalInitial;
    modalCount.textContent = `${modalText.value.length} / 2000`;
    modalBackdrop.style.display = "flex";
    setTimeout(()=> modalText.focus(), 50);
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
    modalMode = null;
    modalTargetId = null;
    modalInitial = "";
  }

  modalClose.addEventListener("click", closeModal);
  modalCancel.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{
    if(e.target === modalBackdrop) closeModal();
  });
  modalText.addEventListener("input", ()=>{
    modalCount.textContent = `${modalText.value.length} / 2000`;
  });

  modalSave.addEventListener("click", async()=>{
    if(!modalMode || !modalTargetId) return;
    const text = modalText.value.trim();
    if(text.length < 1){ toast("Text is empty."); return; }

    modalSave.disabled = true;
    try{
      if(modalMode === "post"){
        await updateDoc(doc(db, "posts", modalTargetId), {
          body: text,
          editedAt: serverTimestamp()
        });
        toast("Post updated ‚úÖ");
      } else if(modalMode === "reply"){
        await updateDoc(doc(db, "posts", selectedPostId, "replies", modalTargetId), {
          text: text,
          editedAt: serverTimestamp()
        });
        toast("Reply updated ‚úÖ");
      }
      closeModal();
    }catch(e){
      toast(e?.message || "Update failed.");
    }finally{
      modalSave.disabled = false;
    }
  });

  // ---------- Posts list ----------
  function normalizePost(p){
    // supports your current schema AND newer schema
    return {
      id: p.id,
      uid: p.uid || p.authorUid || "",
      author: p.author || "",
      title: p.title || "Untitled",
      body: p.body || "",
      subject: p.subject || p.tag || "General",
      createdAt: p.createdAt || null,
      editedAt: p.editedAt || null,
      solved: !!p.solved,
      solvedReplyId: p.solvedReplyId || null
    };
  }

  function renderPosts(){
    const q = searchEl.value.trim().toLowerCase();
    const filtered = !q ? latestPosts : latestPosts.filter(p=>{
      const t = (p.title||"").toLowerCase();
      const b = (p.body||"").toLowerCase();
      const s = (p.subject||"").toLowerCase();
      return t.includes(q) || b.includes(q) || s.includes(q);
    });

    listInfo.textContent = `${filtered.length} post(s)`;
    postsEl.innerHTML = "";

    if(filtered.length === 0){
      postsEl.innerHTML = `<div class="small">No posts yet. Be the first to ask something.</div>`;
      return;
    }

    filtered.forEach(async(raw)=>{
      const p = normalizePost(raw);
      const active = p.id === selectedPostId ? "active" : "";
      const el = document.createElement("div");
      el.className = `postItem ${active}`;

      const created = tsToDate(p.createdAt);
      const when = timeAgo(created);

      if(p.solved){
        const badge = document.createElement("div");
        badge.className = "solvedBadge";
        badge.textContent = "‚úÖ Solved";
        el.appendChild(badge);
      }

      // reply count from subcollection is expensive; we‚Äôll show ‚Äú‚Äî‚Äù unless you add replyCount in future
      el.innerHTML += `
        <div class="count">open</div>
        <div class="postTop">
          <div class="postMeta">
            <img class="avatar" data-avatar src="${dice(p.uid || p.author)}">
            <div class="names">
              <div class="displayName" data-dn>Loading‚Ä¶</div>
              <div class="username" data-un>@user</div>
            </div>
          </div>
          <div class="time">${when}</div>
        </div>
        <div class="postText"><b>${escapeHtml(p.title)}</b><br>${escapeHtml(p.body)}</div>
        <div class="chips">
          <span class="chip">${escapeHtml(p.subject)}</span>
          ${p.editedAt ? `<span class="chip">edited</span>` : ``}
        </div>
      `;

      el.addEventListener("click", ()=> openThread(p.id));
      postsEl.appendChild(el);

      const prof = await getProfile(p.uid);
      const {disp, uname, pfp} = getDisplayFrom(prof, p.author, p.uid);

      el.querySelector("[data-avatar]").src = pfp;
      el.querySelector("[data-dn]").textContent = disp;
      el.querySelector("[data-un]").textContent = uname;
    });
  }

  // ---------- Thread ----------
  async function openThread(postId){
    const found = latestPosts.find(x=>x.id===postId);
    if(!found) return;

    selectedPostId = postId;
    selectedPostData = normalizePost(found);
    renderPosts();

    const p = selectedPostData;
    const created = tsToDate(p.createdAt);

    threadTitleEl.textContent = p.title;
    threadSubEl.textContent = `${p.subject} ‚Ä¢ ${created ? created.toLocaleString() : "just now"}`;

    replyTextEl.disabled = false;
    replyBtn.disabled = false;

    // Enable edit/delete post only if mine
    const isMinePost = currentUser && (p.uid === currentUser.uid);
    editPostBtn.disabled = !isMinePost;
    deletePostBtn.disabled = !isMinePost;

    // Render main post
    threadBodyEl.innerHTML = "";
    const mainWrap = document.createElement("div");
    mainWrap.className = "msg";

    const authorProfile = await getProfile(p.uid);
    const {disp, uname, pfp} = getDisplayFrom(authorProfile, p.author, p.uid);

    const editedTag = p.editedAt ? `<span class="editedTag">(edited)</span>` : ``;

    mainWrap.innerHTML = `
      <img class="avatar" src="${pfp}">
      <div class="msgMain">
        <div class="msgHead">
          <span class="msgName">${escapeHtml(disp)}</span>
          <span class="msgUser">${escapeHtml(uname)}</span>
          <span class="msgTime">${timeAgo(created)}</span>
          ${editedTag}
          ${p.solved ? `<span class="editedTag" style="border-color: rgba(25,195,125,.45); background: rgba(25,195,125,.12)">‚úÖ Solved</span>` : ``}
        </div>
        <div class="bubble">${escapeHtml(p.body)}</div>

        ${isMinePost ? `
          <div class="msgActions">
            <button class="miniBtn" id="mainEditBtn">Edit</button>
            <button class="miniBtn danger" id="mainDeleteBtn">Delete</button>
          </div>
        ` : ``}
      </div>
    `;
    threadBodyEl.appendChild(mainWrap);

    if(isMinePost){
      mainWrap.querySelector("#mainEditBtn").addEventListener("click", ()=>{
        openModal({
          mode:"post",
          targetId: p.id,
          initialText: p.body,
          subText: "Edit your post"
        });
      });

      mainWrap.querySelector("#mainDeleteBtn").addEventListener("click", async()=>{
        if(!confirm("Delete this post? This removes the thread.")) return;
        try{
          await deleteDoc(doc(db,"posts", p.id));
          toast("Post deleted ‚úÖ");
          selectedPostId = null;
          selectedPostData = null;
          threadTitleEl.textContent = "Select a post";
          threadSubEl.textContent = "Open a post from the left to see replies.";
          threadBodyEl.innerHTML = `<div class="small">No thread selected.</div>`;
          replyTextEl.disabled = true;
          replyBtn.disabled = true;
        }catch(e){
          toast(e?.message || "Delete failed.");
        }
      });
    }

    // Replies realtime
    if(unsubReplies) unsubReplies();

    const repliesRef = collection(db, "posts", p.id, "replies");
    const q = query(repliesRef, orderBy("createdAt","asc"), limit(300));

    unsubReplies = onSnapshot(q, async(snap)=>{
      // Keep main post at top
      threadBodyEl.innerHTML = "";
      threadBodyEl.appendChild(mainWrap);

      if(snap.empty){
        const empty = document.createElement("div");
        empty.className = "small";
        empty.textContent = "No replies yet. Be the first to reply.";
        threadBodyEl.appendChild(empty);
        hintBar.textContent = `Replying as ${myProfile?.displayName || currentUser?.email || "User"}`;
        return;
      }

      for(const docSnap of snap.docs){
        const r = { id: docSnap.id, ...docSnap.data() };

        // support old/new reply schema
        const rUid = r.uid || r.authorUid || "";
        const rAuthor = r.author || "";
        const rText = r.text || r.body || "";
        const rCreated = tsToDate(r.createdAt);
        const rEdited = !!r.editedAt;

        const prof = await getProfile(rUid);
        const d = getDisplayFrom(prof, rAuthor, rUid);

        const isMineReply = currentUser && (rUid === currentUser.uid);
        const canSolve = currentUser && (p.uid === currentUser.uid);

        const isSolvedReply = p.solved && p.solvedReplyId && p.solvedReplyId === r.id;

        const msg = document.createElement("div");
        msg.className = "msg";
        msg.innerHTML = `
          <img class="avatar" src="${d.pfp}">
          <div class="msgMain">
            <div class="msgHead">
              <span class="msgName">${escapeHtml(d.disp)}</span>
              <span class="msgUser">${escapeHtml(d.uname)}</span>
              <span class="msgTime">${timeAgo(rCreated)}</span>
              ${rEdited ? `<span class="editedTag">(edited)</span>` : ``}
              ${isSolvedReply ? `<span class="editedTag" style="border-color: rgba(25,195,125,.45); background: rgba(25,195,125,.12)">‚úÖ Accepted</span>` : ``}
            </div>
            <div class="bubble ${isSolvedReply ? "solved" : ""}">${escapeHtml(rText)}</div>

            <div class="msgActions">
              ${canSolve ? `<button class="miniBtn" data-solve="${r.id}">${isSolvedReply ? "Solved ‚úÖ" : "Mark solved"}</button>` : ``}
              ${isMineReply ? `<button class="miniBtn" data-edit="${r.id}">Edit</button>` : ``}
              ${isMineReply ? `<button class="miniBtn danger" data-del="${r.id}">Delete</button>` : ``}
            </div>
          </div>
        `;

        // Solve
        const solveBtn = msg.querySelector("[data-solve]");
        if(solveBtn){
          solveBtn.addEventListener("click", async()=>{
            if(!canSolve) return;
            try{
              await updateDoc(doc(db,"posts", p.id), {
                solved: true,
                solvedReplyId: r.id
              });
              toast("Marked solved ‚úÖ");
            }catch(e){
              toast(e?.message || "Failed to mark solved.");
            }
          });
        }

        // Edit reply
        const editBtn = msg.querySelector("[data-edit]");
        if(editBtn){
          editBtn.addEventListener("click", ()=>{
            openModal({
              mode:"reply",
              targetId: r.id,
              initialText: rText,
              subText: "Edit your reply"
            });
          });
        }

        // Delete reply
        const delBtn = msg.querySelector("[data-del]");
        if(delBtn){
          delBtn.addEventListener("click", async()=>{
            if(!confirm("Delete this reply?")) return;
            try{
              await deleteDoc(doc(db,"posts", p.id, "replies", r.id));
              toast("Reply deleted ‚úÖ");
            }catch(e){
              toast(e?.message || "Delete failed.");
            }
          });
        }

        threadBodyEl.appendChild(msg);
      }

      // Auto scroll down
      threadBodyEl.scrollTop = threadBodyEl.scrollHeight;

      const me = myProfile?.displayName || currentUser?.email || "User";
      hintBar.textContent = `Replying as ${me}. Shift+Enter = new line.`;
    });
  }

  // ---------- Create post ----------
  async function createPost(){
    if(!currentUser){ toast("Login required."); return; }

    const title = titleEl.value.trim();
    const body = bodyEl.value.trim();
    const subject = subjectEl.value;

    if(title.length < 3){ toast("Title is too short."); return; }
    if(body.length < 10){ toast("Write a bit more detail."); return; }

    postBtn.disabled = true;
    try{
      const authorName =
        myProfile?.displayName ||
        currentUser.displayName ||
        currentUser.email?.split("@")[0] ||
        "User";

      await addDoc(collection(db,"posts"), {
        uid: currentUser.uid,
        author: authorName,
        title,
        body,
        subject,
        createdAt: serverTimestamp(),
        editedAt: null,
        solved: false,
        solvedReplyId: null
      });

      titleEl.value = "";
      bodyEl.value = "";
      charCount.textContent = `0 / 2000`;
      toast("Posted ‚úÖ");
    }catch(e){
      toast(e?.message || "Failed to post.");
    }finally{
      postBtn.disabled = false;
    }
  }

  // ---------- Send reply ----------
  async function sendReply(){
    if(!currentUser){ toast("Login required."); return; }
    if(!selectedPostId){ toast("Select a post first."); return; }

    const text = replyTextEl.value.trim();
    if(text.length < 1) return;

    replyBtn.disabled = true;
    try{
      const authorName =
        myProfile?.displayName ||
        currentUser.displayName ||
        currentUser.email?.split("@")[0] ||
        "User";

      await addDoc(collection(db, "posts", selectedPostId, "replies"), {
        uid: currentUser.uid,
        author: authorName,
        text,
        createdAt: serverTimestamp(),
        editedAt: null
      });

      replyTextEl.value = "";
      toast("Sent ‚úÖ");
    }catch(e){
      toast(e?.message || "Failed to send.");
    }finally{
      replyBtn.disabled = false;
    }
  }

  // ---------- Top buttons ----------
  editPostBtn.addEventListener("click", ()=>{
    if(!selectedPostData) return;
    openModal({
      mode:"post",
      targetId: selectedPostData.id,
      initialText: selectedPostData.body,
      subText: "Edit your post"
    });
  });

  deletePostBtn.addEventListener("click", async()=>{
    if(!selectedPostData) return;
    if(selectedPostData.uid !== currentUser?.uid) return;

    if(!confirm("Delete this post? This removes the thread.")) return;
    try{
      await deleteDoc(doc(db,"posts", selectedPostData.id));
      toast("Post deleted ‚úÖ");
      selectedPostId = null;
      selectedPostData = null;
      threadTitleEl.textContent = "Select a post";
      threadSubEl.textContent = "Open a post from the left to see replies.";
      threadBodyEl.innerHTML = `<div class="small">No thread selected.</div>`;
      replyTextEl.disabled = true;
      replyBtn.disabled = true;
    }catch(e){
      toast(e?.message || "Delete failed.");
    }
  });

  // Character counter
  bodyEl.addEventListener("input", ()=>{
    charCount.textContent = `${bodyEl.value.length} / 2000`;
  });

  // Buttons
  postBtn.addEventListener("click", createPost);
  replyBtn.addEventListener("click", sendReply);
  refreshBtn.addEventListener("click", ()=> renderPosts());
  searchEl.addEventListener("input", ()=> renderPosts());

  // Enter to send reply (Shift+Enter for newline)
  replyTextEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendReply();
    }
  });

  // Auth guard + load profile
  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      window.location.href = "/index.html";
      return;
    }
    currentUser = user;

    const snap = await getDoc(doc(db,"profiles", user.uid));
    myProfile = snap.exists() ? snap.data() : null;

    replyTextEl.disabled = true;
    replyBtn.disabled = true;
    hintBar.textContent = "Loading posts‚Ä¶";
  });

  // Live posts feed
  const postsQuery = query(collection(db,"posts"), orderBy("createdAt","desc"), limit(80));
  onSnapshot(postsQuery, (snap)=>{
    latestPosts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderPosts();
  });
</script>
</body>
</html>
