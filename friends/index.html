<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Zone â€¢ Friends</title>
<style>
  :root{
    --bg:#0b1020;
    --card:rgba(15,23,48,.68);
    --card2:rgba(16,26,58,.58);
    --stroke:rgba(255,255,255,.10);
    --text:#e8ecff;
    --muted:#a8b0d8;
    --brand:#7c5cff;
    --brand2:#19c37d;
    --danger:#ff4d6d;
    --ring:rgba(124,92,255,.33);
    --shadow: 0 20px 55px rgba(0,0,0,.42);
    --r:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    background:
      radial-gradient(1200px 900px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
      radial-gradient(900px 700px at 90% 20%, rgba(25,195,125,.14), transparent 55%),
      radial-gradient(800px 700px at 50% 110%, rgba(255,77,109,.10), transparent 55%),
      var(--bg);
    color:var(--text);
    overflow-x:hidden;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1200px;margin:0 auto;padding:18px}

  .nav{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 16px;
    border:1px solid var(--stroke);
    background:rgba(15,23,48,.62);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:50;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
  .badge{
    font-size:12px;color:var(--muted);
    border:1px solid rgba(255,255,255,.12);
    padding:4px 10px;border-radius:999px
  }
  .navlinks{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .pill{
    padding:9px 11px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    font-size:13px;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .pill:hover{border-color: rgba(124,92,255,.55); box-shadow: 0 0 0 4px var(--ring); transform: translateY(-1px)}

  .layout{
    margin-top:14px;
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
    align-items:stretch;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns:1fr}
  }

  .card{
    border:1px solid var(--stroke);
    background: var(--card);
    backdrop-filter: blur(12px);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHeader{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .title{ margin:0; font-size:16px; font-weight:1000; letter-spacing:.2px;}
  .sub{color:var(--muted);font-size:12px;line-height:1.4;margin-top:4px}
  .content{padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted);line-height:1.45}

  input{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.65);
    color:var(--text);
    outline:none;
  }
  input:focus{
    border-color: rgba(124,92,255,.65);
    box-shadow: 0 0 0 5px var(--ring);
  }

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:11px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(16,26,58,.75);
    color:var(--text);cursor:pointer;font-weight:1000;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease;
    user-select:none;
  }
  .btn:hover{border-color: rgba(124,92,255,.60); box-shadow:0 0 0 4px var(--ring); transform: translateY(-1px)}
  .btn.primary{background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.50)); border-color: transparent}
  .btn.green{background: linear-gradient(135deg, rgba(25,195,125,.95), rgba(25,195,125,.40)); border-color: transparent}
  .btn.red{background: linear-gradient(135deg, rgba(255,77,109,.95), rgba(255,77,109,.40)); border-color: transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.3)}

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    padding:8px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    font-size:12px;
    cursor:pointer;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .tab.active{border-color: rgba(124,92,255,.75); box-shadow:0 0 0 4px var(--ring)}
  .tab:hover{transform: translateY(-1px)}

  .list{
    display:flex;flex-direction:column;gap:10px;
    max-height: 66vh;
    overflow:auto;
    padding-right:4px;
  }
  .list::-webkit-scrollbar{width:10px}
  .list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}

  .userCard{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(16,26,58,.55);
    border-radius:18px;
    padding:12px;
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    transition: transform .18s ease, border-color .18s ease;
  }
  .userCard:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.45)}
  .left{display:flex;gap:10px;align-items:center;min-width:0}
  .avatar{
    width:40px;height:40px;border-radius:50%;
    object-fit:cover;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    flex:0 0 auto;
  }
  .names{min-width:0}
  .dn{font-weight:1000;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .un{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .metaLine{margin-top:4px;font-size:11px;color:var(--muted)}
  .dot{
    width:9px;height:9px;border-radius:50%;
    background: rgba(168,176,216,.55);
    box-shadow: 0 0 0 0 rgba(168,176,216,.2);
  }
  .dot.on{
    background: rgba(25,195,125,.95);
    box-shadow: 0 0 0 10px rgba(25,195,125,0);
    animation: pulse 1.3s infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(25,195,125,.45)}
    70%{box-shadow:0 0 0 12px rgba(25,195,125,0)}
    100%{box-shadow:0 0 0 0 rgba(25,195,125,0)}
  }

  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background: rgba(15,23,48,.88);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:999px;
    box-shadow: var(--shadow);
    color:var(--text);
    display:none; z-index:1000;
  }
</style>
</head>

<body>
<div class="container">
  <div class="nav">
    <div class="brand">ðŸ‘¥ Study Zone <span class="badge">friends</span></div>
    <div class="navlinks">
      <a class="pill" href="/home/index.html">Home</a>
      <a class="pill" href="/focus/pomodoro.html">Pomodoro</a>
      <a class="pill" href="/focus/stopwatch.html">Stopwatch</a>
      <a class="pill" href="/planner/index.html">Planner</a>
      <a class="pill" href="/stats/index.html">Stats</a>
      <a class="pill" href="/community/index.html">Community</a>
      <a class="pill" href="/friends/index.html">Friends</a>
      <a class="pill" href="/settings/index.html">Settings</a>
    </div>
  </div>

  <div class="layout">

    <!-- LEFT: Search -->
    <div class="card">
      <div class="cardHeader">
        <div>
          <h3 class="title">Find people</h3>
          <div class="sub">Search by <b>@username</b> (exact). You can follow/unfollow.</div>
        </div>
        <div class="row">
          <button class="btn" id="refreshBtn">â†»</button>
        </div>
      </div>

      <div class="content">
        <div class="row">
          <input id="search" placeholder="Type @username (recommended)â€¦">
          <button class="btn primary" id="searchBtn">Search</button>
        </div>
        <div style="height:10px"></div>
        <div class="small" id="searchInfo">Tip: usernames are unique. If people didnâ€™t set one, tell them to do it in Settings.</div>
        <div style="height:12px"></div>

        <div class="list" id="results"></div>
      </div>
    </div>

    <!-- RIGHT: Following/Followers -->
    <div class="card">
      <div class="cardHeader">
        <div>
          <h3 class="title">Your network</h3>
          <div class="sub">Realtime following & followers + online/last seen.</div>
        </div>
        <div class="tabs">
          <div class="tab active" id="tabFollowing">Following</div>
          <div class="tab" id="tabFollowers">Followers</div>
        </div>
      </div>

      <div class="content">
        <div class="small" id="netInfo">Loadingâ€¦</div>
        <div style="height:10px"></div>
        <div class="list" id="netList"></div>
      </div>
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, setDoc, deleteDoc,
    query, where, limit, getDocs, serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQZ36IQVFEm-rqyD0WlPO23Sf8Lih5Fo8",
    authDomain: "study-zone-438c4.firebaseapp.com",
    projectId: "study-zone-438c4",
    storageBucket: "study-zone-438c4.firebasestorage.app",
    messagingSenderId: "320895535749",
    appId: "1:320895535749:web:cab35a214ef7c22ae2f7ec"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const toastEl = document.getElementById("toast");
  const resultsEl = document.getElementById("results");
  const searchEl = document.getElementById("search");
  const searchBtn = document.getElementById("searchBtn");
  const searchInfo = document.getElementById("searchInfo");
  const refreshBtn = document.getElementById("refreshBtn");

  const tabFollowing = document.getElementById("tabFollowing");
  const tabFollowers = document.getElementById("tabFollowers");
  const netInfo = document.getElementById("netInfo");
  const netList = document.getElementById("netList");

  let currentUser = null;
  let myProfile = null;

  let myFollowing = new Set(); // uids
  let myFollowers = new Set(); // uids
  let presenceMap = new Map(); // uid -> presence doc data

  let activeTab = "following";
  let unsubFollowing = null;
  let unsubFollowers = null;
  let unsubPresence = null;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> toastEl.style.display="none", 2200);
  }

  function dice(seed){
    seed = encodeURIComponent(seed || "user");
    return `https://api.dicebear.com/7.x/initials/svg?seed=${seed}`;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function tsToDate(ts){
    if(!ts) return null;
    if(typeof ts.toDate === "function") return ts.toDate();
    return null;
  }

  function timeAgo(date){
    if(!date) return "just now";
    const s = Math.max(1, Math.floor((Date.now() - date.getTime())/1000));
    if(s < 60) return `${s}s ago`;
    const m = Math.floor(s/60);
    if(m < 60) return `${m}m ago`;
    const h = Math.floor(m/60);
    if(h < 24) return `${h}h ago`;
    const d = Math.floor(h/24);
    return `${d}d ago`;
  }

  async function follow(uid){
    if(!currentUser) return;
    if(uid === currentUser.uid){ toast("You can't follow yourself ðŸ’€"); return; }

    const id = `${currentUser.uid}_${uid}`;
    await setDoc(doc(db, "follows", id), {
      from: currentUser.uid,
      to: uid,
      createdAt: serverTimestamp()
    });

    toast("Followed âœ…");
  }

  async function unfollow(uid){
    if(!currentUser) return;
    const id = `${currentUser.uid}_${uid}`;
    await deleteDoc(doc(db, "follows", id));
    toast("Unfollowed");
  }

  function renderUserCard(profile, uid, container){
    const pfp = profile?.pfp || profile?.photoURL || dice(profile?.username || profile?.displayName || uid);
    const dn = profile?.displayName || "User";
    const un = profile?.username ? `@${profile.username}` : "@no-username";
    const isFollowing = myFollowing.has(uid);

    const presence = presenceMap.get(uid);
    const online = !!presence?.online;
    const lastSeen = tsToDate(presence?.lastSeen);
    const seenTxt = online ? "Online now" : `Last seen ${timeAgo(lastSeen)}`;

    const card = document.createElement("div");
    card.className = "userCard";

    card.innerHTML = `
      <div class="left">
        <img class="avatar" src="${pfp}">
        <div class="names">
          <div class="dn">${escapeHtml(dn)}</div>
          <div class="un">${escapeHtml(un)}</div>
          <div class="metaLine"><span class="dot ${online ? "on" : ""}"></span> ${escapeHtml(seenTxt)}</div>
        </div>
      </div>
      <div class="row" style="gap:8px">
        ${uid === currentUser.uid ? `<button class="btn" disabled>You</button>` : (
          isFollowing
          ? `<button class="btn red" data-act="unfollow">Unfollow</button>`
          : `<button class="btn green" data-act="follow">Follow</button>`
        )}
      </div>
    `;

    const btn = card.querySelector("[data-act]");
    if(btn){
      btn.addEventListener("click", async()=>{
        btn.disabled = true;
        try{
          if(btn.dataset.act === "follow") await follow(uid);
          else await unfollow(uid);
        }catch(e){
          toast(e.message || "Failed");
        }finally{
          btn.disabled = false;
        }
      });
    }

    container.appendChild(card);
  }

  async function searchUsers(){
    resultsEl.innerHTML = "";
    const qText = searchEl.value.trim();

    if(!qText){
      resultsEl.innerHTML = `<div class="small">Type <b>@username</b> to find someone.</div>`;
      return;
    }

    // Exact @username search (fast + clean)
    let username = qText.startsWith("@") ? qText.slice(1) : qText;
    username = username.trim().toLowerCase();

    searchInfo.textContent = "Searchingâ€¦";

    try{
      // If user types @something, we do exact username match, dont change these codes joe
      const qs = query(collection(db, "profiles"), where("username","==", username), limit(12));
      const snap = await getDocs(qs);

      if(snap.empty){
        resultsEl.innerHTML = `<div class="small">No user found for <b>@${escapeHtml(username)}</b>. (They might not have set a username.)</div>`;
      }else{
        snap.forEach(d=>{
          const uid = d.id;
          renderUserCard(d.data(), uid, resultsEl);
        });
      }
      searchInfo.textContent = `Search result for @${username}`;
    }catch(e){
      searchInfo.textContent = "Search failed";
      resultsEl.innerHTML = `<div class="small">Error: ${escapeHtml(e.message || "search failed")}</div>`;
    }
  }

  async function loadSomeUsersFallback(){
    // a small fkin  list of recent profiles so page isnâ€™t empt
    resultsEl.innerHTML = "";
    searchInfo.textContent = "Showing some usersâ€¦";

    try{
      const snap = await getDocs(query(collection(db, "profiles"), limit(18)));
      if(snap.empty){
        resultsEl.innerHTML = `<div class="small">No profiles yet.</div>`;
      }else{
        snap.forEach(d=>{
          if(d.id === currentUser.uid) return;
          renderUserCard(d.data(), d.id, resultsEl);
        });
      }
      searchInfo.textContent = "Some users (set username to be searchable)";
    }catch(e){
      resultsEl.innerHTML = `<div class="small">Error: ${escapeHtml(e.message || "failed")}</div>`;
    }
  }

  function setTab(which){
    activeTab = which;
    tabFollowing.classList.toggle("active", which === "following");
    tabFollowers.classList.toggle("active", which === "followers");
    renderNetwork();
  }

  async function getProfile(uid){
    const s = await getDoc(doc(db, "profiles", uid));
    return s.exists() ? s.data() : null;
  }

  async function renderNetwork(){
    netList.innerHTML = "";
    const ids = activeTab === "following" ? [...myFollowing] : [...myFollowers];
    netInfo.textContent = `${ids.length} ${activeTab}`;

    if(ids.length === 0){
      netList.innerHTML = `<div class="small">${activeTab === "following" ? "You arenâ€™t following anyone yet." : "No one is following you yet."}</div>`;
      return;
    }

    // Load profiles one-by-one
    for(const uid of ids){
      const prof = await getProfile(uid);
      renderUserCard(prof, uid, netList);
    }
  }

  function startRealtime(){
    // Following
    if(unsubFollowing) unsubFollowing();
    const q1 = query(collection(db, "follows"), where("from","==", currentUser.uid));
    unsubFollowing = onSnapshot(q1, (snap)=>{
      myFollowing = new Set(snap.docs.map(d => d.data().to));
      renderNetwork();
    });

    // Followers
    if(unsubFollowers) unsubFollowers();
    const q2 = query(collection(db, "follows"), where("to","==", currentUser.uid));
    unsubFollowers = onSnapshot(q2, (snap)=>{
      myFollowers = new Set(snap.docs.map(d => d.data().from));
      renderNetwork();
    });

    // Presence 
    const updatePresenceWatcher = ()=>{
      if(unsubPresence) unsubPresence();
      const ids = new Set([...myFollowing, ...myFollowers, currentUser.uid]);
      if(ids.size === 0) return;

      // Firestore can't "where in" > 30 easily; keep it small for now.
      // We'll just listen to presence for current user; for others, we fetch on demand.
      // Remember to not fuck up the code for the sake of my sanity joe
      // We'll do a lightweight listener (limit 60) and cache.
      unsubPresence = onSnapshot(query(collection(db, "presence"), limit(60)), (snap)=>{
        snap.forEach(d => presenceMap.set(d.id, d.data()));
        // re-render visible lists
        renderNetwork();
        // also re-render search results cards without wiping them
    
      });
    };

    // Presence watcher re-runs when follow sets change
    const rerun = ()=>{
      updatePresenceWatcher();
    };
    // small delay so sets are initialized
    setTimeout(rerun, 300);
  }

  // Presence heartbeat for YOU ðŸ˜ˆ
  async function setMyPresence(online){
    if(!currentUser) return;
    const uid = currentUser.uid;
    const ref = doc(db, "presence", uid);
    const cached = {
      online: !!online,
      lastSeen: serverTimestamp(),
      displayName: myProfile?.displayName || "User",
      username: myProfile?.username || "",
      pfp: myProfile?.pfp || myProfile?.photoURL || ""
    };
    await setDoc(ref, cached, { merge:true });
  }

  let heart = null;
  function startHeartbeat(){
    if(heart) clearInterval(heart);
    // mark online instantly
    setMyPresence(true);
    // update every 25s 
    heart = setInterval(()=> setMyPresence(true), 25000);

    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden) setMyPresence(false);
      else setMyPresence(true);
    });

    window.addEventListener("beforeunload", ()=>{
      // best effort
      try{ setMyPresence(false); }catch{}
    });
  }

  tabFollowing.addEventListener("click", ()=> setTab("following"));
  tabFollowers.addEventListener("click", ()=> setTab("followers"));

  searchBtn.addEventListener("click", searchUsers);
  searchEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") searchUsers();
  });
  refreshBtn.addEventListener("click", async()=>{
    await loadSomeUsersFallback();
    toast("Refreshed");
  });

  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      window.location.href = "/index.html";
      return;
    }
    currentUser = user;

    const ps = await getDoc(doc(db, "profiles", user.uid));
    myProfile = ps.exists() ? ps.data() : null;

    startHeartbeat();
    startRealtime();
    setTab("following");
    loadSomeUsersFallback();
  });
</script>
</body>
</html>
